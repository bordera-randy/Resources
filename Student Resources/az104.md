# AZ-104 Exam Resources

## Table of Contents
- [AZ-104 Exam Resources](#az-104-exam-resources)
  - [Table of Contents](#table-of-contents)
  - [Documentation](#documentation)
  - [Labs](#labs)
  - [Study Guides](#study-guides)
  - [Learning Modules](#learning-modules)
  - [Student Resources](#student-resources)

## Documentation
- [Microsoft Learn: AZ-104 Exam](https://learn.microsoft.com/en-us/certifications/exams/az-104)
- [Azure Administrator Documentation](https://learn.microsoft.com/en-us/training/courses/az-104t00)

## Labs
- [AZ-104 Labs](https://microsoftlearning.github.io/AZ-104-MicrosoftAzureAdministrator/)

## Study Guides
- [Exam AZ-104 Study Guide](https://learn.microsoft.com/en-us/certifications/resources/study-guides/az-104)
- [Whizlabs AZ-104 Study Guide](https://www.whizlabs.com/blog/az-104-exam-preparation-guide/)

## Learning Modules
- [Manage Azure identities and governance](https://learn.microsoft.com/en-us/training/modules/manage-azure-identities/)
- [Implement and manage storage](https://learn.microsoft.com/en-us/training/modules/implement-and-manage-storage/)
- [Deploy and manage Azure compute resources](https://learn.microsoft.com/en-us/training/modules/deploy-and-manage-azure-compute-resources/)
- [Configure and manage virtual networking](https://learn.microsoft.com/en-us/training/modules/configure-and-manage-virtual-networking/)
- [Monitor and back up Azure resources](https://learn.microsoft.com/en-us/training/modules/monitor-and-back-up-azure-resources/)

## Student Resources
- [Microsoft Learn: Student Hub](https://learn.microsoft.com/en-us/training/student-hub/)
- [Azure for Students](https://azure.microsoft.com/en-us/free/students/)

# Study Guide 

## 1.1.  Management - Azure Cloud Shell 

### Azure Cloud Shell 
- Browser-accessible shell for managing Azure resources
- Can provide Bash or PowerShell
- In background it uses dockerized version of PowerShell / bash
- When you open it for the first time:
  1.  It creates a new storage account called azcloudshell and some numbers
  21.  It then creates a file share that stores your user information.

## 1.21.  Management - Resources & Costs 

### Subscriptions 

#### Resource tagging 
- Tags are additional metadata that can be assigned to resources/resource groups.
- Child resources d1. not inherit resource groups tags
- Max 15 tag name/value pairs1.   
  E.g1.  CostCenter = YHZ
- Why?
  1.  Organize
  21.  Search
  31.  View
  41.  Billing & cost managements

On Portal:
- You can search for Tags and see filtered lists.
- Resources are tagged after resource is created as opposed to PowerShell/CLI.

#### Resource Tagging and Cost Center Spending Limits 

##### Spending Limits 
- Applies to free trial subscriptions, MSDN and Visual Studi1. subscriptions.
- If spending limit is exceeded:
  1.  Email message is sent
  21.  Deployed resources are disabled in next billing cycle1.  
  31.  Databases and storage accounts become read-only 

- Free trials can be upgraded to Pay-as-you-g1. 
- D1. not apply to support plans, pay-as-you-go, Enterprise Dev/Test 

#### ARM Consumption API 
- Returns usage details 
- Supported only in Enterprise enrollments and Web Direct subscriptions 
- Available through CLI and different SDKs1.  
- Consumption APIs:
  - Enterprise customers only: Price Sheet, Budgets, Balance 
  - Reserved VMs: Reservation Summaries API, Reservation Details API, Reservation recommendations API 
  - Others: Marketplace charges, usage details 

#### Azure Pricing Calculator 
- Estimates monthly costs 
- See online 

#### Azure Advisor Cost Recommendations 
- Identifies wastage 
  - E.g1.  idle VMs, SQL DBs.
  - Can configure automatic shutdown 
  - Auto-shutdown option in VM.

- Recommendations about: 
  - High availability 
  - Security 
  - Performance 
  - Cost recommendations, e.g.:
    - Virtual machine reserved instances to reduce costs.
    - VM resizing: Scale up / down 
    - Remove unprovisioned ExpressRoute circuits.

- Configure rule: 
  - E.g1.  Average CPU Utilization < 5%

Subscription blade:
- In Cost analysis you can filter by Tags.
- Invoices 
- Manage in Subscription blade:
  - Manage payment methods 
    - Adding one allows you to remove subscription limits.
  - Download usage details 
  - Transfer/cancel subscription 
  - Set-up billing alerts 
    - E.g1.  e-mail if billing total is $150

#### Optimizing VM costs 
- Use VM Reserved Instances 
  - You can create one in Reservations blade
- Set-up auto shutdown in VMs 
  - Auto-shutdown blade in VM.

#### Microsoft Azure Resource Providers 
- Enables Azure features.
- Many are registered automatically:
  - E.g1.  Microsoft.Compute that handles VMs, Microsoft.Network, Microsoft.Sql, Microsoft.Storage
- Some are not registered automatically:
  - E.g1.  Microsoft.PolicyInsights, Microsoft.AzureActiveDirectory, Microsoft.AzureStack, Microsoft.Botservice
  - Custom providers can be registered with subscription.
    - Requires the Contributor or Owner roles.
    - In most cases providers are registered automatically when you deploy resources that uses the providers.

- You can register, unregister, re-register through Subscription 1.  Resource providers in Portal

## 1.31.  Management - Resource Groups 

### Resource groups 
- Logical grouping of resources that shares the same lifecycles.
  - Resource group holds different unique resources.
  - Resource groups can contain resources that reside in different regions.
  - Location of resource group is just the meta data for the resource group.

### Tags 
- Categorization / organization of resource groups for e.g1.  billing, management 
  - E.g1.  Dept: IT
  - Tags are not inherited
  - Max 15 tag name/value pairs.

### Locks 
- For accidental deletion or accidental changes to resources within a resource group.
- Consists of tw1. locks:
  - CanNotDelete
    - Authorized users can still read and modify a resource, but they can't delete the resource.
  - ReadOnly
    - Authorized users can read a resource, but they can't delete or update the resource.
    - Same as giving everyone a Reader role.
- Locks are inherited from resources within the resource group.

### IAM 
- Access control, RBAC
- Roles are inherited
- Role assignment: Role definition role (role, e.g1.  Reader) + Person/Scope/Service Principal + Scope

### Policies 
- Azure entity that controls behaviors within a resource group
  - Allow you to keep compliant with corporate standards and SLAs.
  - Set in a scope with a name and definition.
  - Scope: E.g1.  resource group, subscription.
  - Definition: E.g1.  "Allow resource types"
  - Name, description, Policy (e.g1.  azurepolicy.rules.json), Parameters (e.g1.  azurepolicy.parameters.json)

### Events 
- Create event subscriptions triggered by the resources group in Event Grid.

### Automation Script 
- Can be added to library to be redeployed later on.
  - All resources cannot be redeployed
  - Must change the name to avoid duplicates.
- ARM templates for resource groups can als1. be found on GitHub.
- You can Add to library, or click on Deploy to deploy directly.

### Moving Resources 
- You can move resources to another resource group or subscription.
  - All resources cannot be moved.
- Ways of moving:
  - Using CLI: `az resource move --destination-group new-rg --id resourceid`
  - In portal: Overview 1.  Move

### Alerts 
1.  Target: What resource and where
21.  Criteria: What specific action
31.  Details: Who, when, where, how
41.  Action Group: Wh1. to inform and how to inform them

### Metrics 
1.  Resource group: Where to look at the metric
21.  Resource type: The type of resource to look at
31.  Available metrics: What specifics about the metrics
41.  Chart: Graphic display of the metric

## 2.1.  Governance - Roles 

### Roles 

#### Role assignments 
- Delegated resource administration
- Roles organize related resource permissions together
  - Depends on resource type
    - E.g1.  different for VM and storage.

- Scope
  - Roles are applied to a scope.
  - They're inherited in following order:
    - Management groups
    - Subscription
    - Resource groups
    - Individual resources

- Role can be assigned to:
  - Users
  - Groups
  - Service principal
    - Application
    - System Assigned Managed Identity: App Service, Function App, Virtual Machine, Virtual Machine Scale Set
    - User Assigned Managed Identity


## Role Types

### Built-in Roles
- 60+ built-in roles
- Common roles:
  - **Owner**: Manage resources and resource access
  - **Contributor**: Manage resources but not resource access
  - **Reader**: Read-only access
  - **Storage Blob Data Reader**: Specific to storage accounts
  - **SQL DB Contributor**: Manage, but not access, SQL databases
  - **VM Contributor**: Manage, but not access, virtual machines

### Custom Roles
- Built using only PowerShell / CLI or REST API
  - `New-AzureRmRoleDefinitation -Role $customRole`
- Shows in the same drop-down lists with built-in roles
- JSON file example:
  ```json
  {
    "Name": "Network Resource Viewer",
    "IsCustom": true,
    "Description": "Allows reading Azure network resources.",
    "Actions": [ "Microsoft.Network/*/read" ],
    "NotActions": [ ],
    "AssignableScopes": [ "/subscriptions/048.." ]
  }
  ```

### Classic Administrator Roles
- The account used to sign up for Azure is automatically set as both the Account Administrator and Service Administrator
  - Roles are properties that can be changed in the Subscription blade
  - Azure recommends using RBAC roles
- **Account Administrator** (1 per Azure account)
  - Conceptually, the billing owner of the subscription
  - No access to the Azure portal
- **Service Administrator** (1 per Azure subscription)
  - By default, for a new subscription, the Account Administrator is als1. the Service Administrator
  - Equivalent access to a user assigned the Owner role at the subscription scope
  - Full access to the Azure portal
- **Co-Administrator** (200 per subscription)
  - Equivalent access to a user assigned the Owner role at the subscription scope

## 2.21.  Governance - Azure AD

### Azure AD

#### Introduction to Active Directory
- Characteristics:
  - **Cloud-based and geo-distributed**: Your tenant is distributed amongst many servers in Azure, providing high availability and scalability
  - **Multi-tenant**: Running a shared platform, each tenant is segmented off on its own, with the ability to give permissions from one tenant to another for certain accounts
  - **Identity & Access**: Can be an identity/access provider for Microsoft accounts (e.g., Office 365) and in-house & third-party developed applications
  - **Integrates with local AD**
  - **Provides SSO**: For third-party or in-house applications
- **Global administrator = Root**
- Managed by Azure Portal, PowerShell/CLI, Microsoft Graph, and API
  - Microsoft Graph: API product creating a single way of interacting with all Microsoft APIs

#### Role Based Access Control
- Roles define actions that a role is capable of doing
  - Roles are assigned to users only
  - Pre-built roles only (No custom roles within Azure AD)
  - Roles are assigned at the tenant level
  - For separation of roles, create a new tenant and assign roles and permissions on that account

#### Custom Domains
- Initially get `tenantname.onmicrosoft.com`
- Custom names must be fully qualified and ownership must be verified
  - Microsoft provides text records (TXT or MX) for verification
  - Verify multiple domains
  - Register subdomains by registering the parent domain
  - In Portal: Active Directory > Custom domain names > Add custom domain

#### Multiple Directories
- **Resource independence**: Resources in one directory d1. not have access to resources in another directory
- **Administrative independence**: Global admin in one directory does not have access in another directory
- **Synchronization independence**: Synchronize to a specific directory without impacting other directories
- **Switch directory**: In Portal > Active Directory > Overview > Switch directory

#### Conditional Access
- Applied to users, locations, devices, applications
- Policies allow:
  - One application with multiple rules
  - One rule with multiple applications
- Only available in Azure AD Premium
- **Condition (if something) 1.  Control (d1. something)**
  - Conditions:
    - Users and groups
      - Groups, User ID, Locations (IP)
    - Cloud apps
    - Device platform and state
      - Domain Joined, Compliant, Lost or Stolen
    - Locations (IP)
    - Client apps
  - Control: Allow, Deny, MFA
    - Multi-factor authentication
    - Compliant device
    - Approved client app
    - Terms of use
    - Custom and session controls
- Manage in AD - Conditional Access
- Example policy: "Marketing app from US only"
  - Assignments:
    - Users and groups: All users
    - Cloud apps: Marketing app (registered in Azure AD)
    - Conditions:
      - Locations: Include any location but exclude Contos1. location
      - Contos1. locations is a named location
      - Set US locations in Portal: Active Directory > Conditional Access > Named locations
      - Client apps: Apply policy with access from Browser but not from mobile apps and desktop clients
  - Access controls: Block access

#### Access Reviews
- Created for an identified reviewer
  - Duration can be set
  - Usually created by administrators
  - Reviewers can approve or deny
- Can be a member of programs
  - A program groups reviews together
- Managed in Access Reviews (separate view, not included in AD)

#### Administrative Units
- Container of resources
- Used for:
  - Delegating administrative permissions over subsets of users
  - Applying policies to a subset of users
- Useful in organizations with independent (autonomous) divisions
- An administrative unit is a directory object that can be created and populated with resources/users
- AD Premium feature
- Example:
  - A central administrator can:
    - Create an administrative unit for a particular school (Business school)
    - Populate it with only the Business school users
    - Add the Business school IT staff to a scoped role, granting them administrative permissions only over the Business school administrative unit



## Identity Protection

### Detection

- **Vulnerabilities**
  - MFA not configured
  - Unmanaged cloud apps
  - Privileged identity management (only grant identity to user for a set period of time)

- **Risk events**
  - Leaked credentials on internet
  - Anonymous IP addresses (VPNs etc.)
  - Suspicious IP addresses
  - Impossible travel (superman event, user logs in from NY and after 5 minutes logs in from Hong Kong)
  - Unknown locations
  - Infected devices

### Investigations

- Receive notifications
- Workflows (when, who, what happened)
- Analysis: How can you apply policies to prevent future events?

### Policies

- **User risk policy**: E.g1.  if user risk event is high, allow access but require password change
- **Sign-in risk**: E.g1.  if sign-in risk is medium, allow access but require MFA

## Auditing and Monitoring

### Active Directory Activity

- **Sign-in**: See, filter, search log-on statuses
- **Audit logs**: See, filter, search activity logs for Azure AD

### Active Directory Users and Groups

- You can see user sign-in risks

### Active Directory Azure AD Connect

- Install Azure AD Connect health from here
- Shows how healthy your Azure AD Connections

## Governance - Azure AD - Entities

### Azure AD Entities

#### Users

##### Types of users

- **Cloud or Synced** (from local AD through AD Connect)
- **Member or Guest**
  - Members are created within AD directory
  - Guests are invited by administrator or one of other users of Azure AD

##### Common settings

- Usual attributes (e.g1.  department, phone number, contact, email)
- Setup password policy, expiration policy, flag users needing to reset their password

##### Usage Location

- Location is required if you want to assign license to a user within AD.
- **Set usage location**:
  - In portal: Active Directory > Users > Select User > Profile > Settings
- **Assign license**:
  - In Portal: Active Directory > Users > Select User > Licenses
- **User Principal Name**: Combination of a user name + domain.

##### Create new user

- AD > User > New User
- **User name**: Required, e.g1.  test@contoso.onmicrosoft.com
- **Properties**: Optional information e.g1.  first name, last name, job title.

##### External access

- You can add a user as an External User
- Good for B2B scenarios
  - AD is not required on other business side.

##### Self-service password reset

- **Scenarios**:
  - Allows users to change their passwords
  - If you cannot log in somehow
  - Helps with account lockout
- **Authentication methods**:
  - Types:
    - Text message/Phone call
    - Secondary email
    - Security questions
  - Administrator requires one or more.
- **Manage in portal**:
  - Steps: Active Directory > Password Reset
  - **Configurations**:
    - Enable
      - You can enable for all users or selected users.
      - Good to first enable for a pilot group to see how it works.
    - Registration
      - Require users to register when signing in
      - Prompts user to fill information for authentication methods.
      - After how long user will be prompted to confirm authentication method information
    - Notifications
      - Notify users on password resets
      - Notify all admins when other admins reset their password

### User settings

#### Enterprise applications

- Users can consent to apps accessing company data on their behalf (yes/no)
  - Yes; users can consent to allow third party and multi-tenant applications to consent on their own behalf.
- Users can add gallery apps to their Access Panel
  - No; as an administrator you have to manually integrate the applications through Access Panel

#### App registrations

- Users can register applications (yes/no)
  - Yes; non-administrations can register applications to be used within the directory, no; only administrators can d1. it

### Groups

#### Types of groups

- **Assigned or Dynamic**:
  - Assigned: You assign users to groups manually
  - Dynamic: You select various attributes to make users member of a group
    - Dynamic query e.g1.  department Equals marketing
- **Security or Office 365**:
  - Security groups are for assigning permissions.

#### Owners and members

- **Owners**: Can add/remove users from the group.
- **Members**: Cannot manage the group, normal permissions

#### Expiration of groups

- Groups can automatically expire.

#### Manage in "Azure Directory > Groups"

- You can assign licenses to a group where each member will get a license.
- Good for performing bulk user updates

#### Self-service group management

- Owners manage groups instead of administrator that manage the group for the owners.
- Users can request to join in group with providing some business justification.
- **Audits & alerts**:
  - Everything is logged
  - You can e.g1.  trigger alert on frequent activities in a group

#### Company Branding

- In portal: Active Directory > Users and groups > Company branding
- Allows you to customize the pages with e.g1.  banner, sign-in page text, user name hint

### Devices

- Enables more management
- Device settings show overview in Portal
  - Intune + MDM offer much more control
- You can add work or school account to integrate

## Registration Types

### Register Device
- Basic registration
- Bring your own device (BYOD) scenario
- For mobile devices and Windows 10
  - Enable/disable and additional management (MDM) for mobile devices like Intune.

### Enterprise State Roaming
- Users synchronize their user settings and application settings data to the cloud.
- Supported in Windows 10
- Enhanced security, management, and monitoring.
- Separation of corporate and consumer data in the cloud.

### Join Device
- Corporate-owned assets that you want to manage
- E.g., Windows 7 or Windows 10
- You get some benefits, e.g., single sign-on.

### Hybrid Join
- You can enable automatic registration for your AD joined computers
- Join device in both local AD and Azure AD
- Grant device user access to apps that need traditional local AD (=on-prem AD) authentication.
- You get service principal for the device
- Actual management is done through Group Policy or System Center Configuration Manager.
  - They're tied into Azure AD but not part of core AD.
- Relies on AD Connect for synchronization
  - If they're already joined to local AD, they're als1. registered in Azure AD automatically.
- Configuration
  - Ensure access to external Azure AD URLs.
  - Configure SCP (service connection point) internally.
  - Configure ADFS if required

### Manage in Portal
- Active Directory > Devices
- Configurations
  - Users may join devices to Azure AD
  - Additional administrators on Azure AD joined devices
    - Default is none, you can select users
  - Users may register their devices with Azure AD
  - Require Multi-Factor Auth to join devices
  - Maximum number of devices per user
  - Users may sync settings and enterprise app data
    - All, selected, None
  - For more, you need PowerShell.

### Azure AD Device Settings/Policies
- Control permissions
  - Who's allowed to access join devices?
- Control sync
  - Enabled/disabled
- Device management through Intune or other MDM
- Conditional access
  - Whether or not device has access to resources within your organization

## Applications
- Azure AD IDaaS (Identity Directory as a Service)
- Application types
  - Third party or internal
  - Pre-integrated or proxies
- Automated user provisioning through SCIM 2.0
  - Use provisioning enables synchronization of user accounts.
  - SCIM
    - System for Cross-domain Identity Management.
    - Defined by IETF
    - Control users, groups, and their relations
  - Available on select SaaS apps
- In portal, you can assign access to applications
  - AD > Applications > Select application > Users and groups

## Hybrid Identities
- Hybrid (common) identity = Cloud + On-Premises identity
- Connection is done through Azure AD Connect

### Four Pillars
- Unified Development and DevOps
  - A common approach to building applications, and full flexibility to deploy in the cloud or on-premises
- Integrated management and security
  - Built-in management and security solutions across the full operational lifecycle from cloud to on-premises
- Common Identity
  - Enable end-user productivity with single sign-on to cloud and on-premises applications while protecting corporate data
  - Single identity
    - Create and manage a single identity for each user across your hybrid enterprise, keeping users, groups, and devices in sync
  - Single Sign-on
    - Provide single sign-on access to your application including thousands of pre-integrated SaaS apps
  - Conditional Access
    - Protect identities by enforcing risk-based conditional access policies and multi-factor authentication for both on-premises and cloud applications
  - Remote Access
    - Provide secure remote access to on-premises web applications through Azure AD Application Proxy
  - Self Service
    - Self-service password reset and application access requests for directories in the datacenter and the cloud
  - High Availability
  - Collaboration
    - Enable vendors, contractors, and partners to get risk-free access to in-house resources
  - Consistency
    - Truly consistent capabilities
- Consistent Data Platform
  - Seamlessly distribute data between cloud and on-premises
  - Enrich with analysis and deep learning

### Azure AD Connect
- Integrate your on-premises AD or LDAP directory to the cloud
- Establish a single identity for your users to access on-premises and cloud-based resources
- Connect your users to thousands of SaaS applications published through Azure
- Manage in Azure AD Connect > Synchronization Service
- Adjust to business changes after Azure AD Connect is installed.
  - Change the service accounts
  - Add the Managers OU to be included in the synchronization

### Preparing for Azure AD Connect
- Create a new user in Azure AD as Global Administrator
- Download Azure AD Connect and install it.
  - You need > Windows Server 2008

### Install and Configure Azure AD Connect
- Installation settings
  - Initially
    - Custom or Express installation
    - Installation location
    - Create an express SQL or use an existing SQL instance
    - Provide a service account or create a new one
    - Service account for SQL server
    - Custom sync groups
      - Fill: Administrators group, operators group, browser group, password reset groups
      - AD Connect groups not domain groups!
  - Then
    - How users will sign-in
      - One of them: Password synchronization, Pass-through authentication, Federation with AD FS
      - Enable sign-on: Yes, No
    - Forest and Azure credentials
      - Global administration username password
      - Select directory type (AD or LDAP)
      - Then type Forest name
      - Create new AD account or use existing AD account
      - Type domain username and password
        - Recommended to enter Enterprise Admin credentials
      - Select UPN for sign-in
        - E.g., azure-contoso.com
      - Select user name: e.g., userPrincipalName, treeName, unicodePwd
  - Then
    - Choose what domains and OUs get synchronized to the cloud
      - Sync all domains and OUs or sync selected domains and OUs
    - How to uniquely identify users
      - Identification:
        - Users are represented only once across all directories.
        - User identities exist across multiple directories.
        - Match using: mail attribute, specific attribute, etc.
      - Source anchor (ID)
        - Let Azure manage the source anchor for me
        - Specific attribute: objectGUID, pager, objectSid, etc.
      - Filter users and devices by group
        - Synchronize all users and devices
        - Synchronize selected
    - Optional features
      - Exchange hybrid deployment
      - Exchange mail public folders
      - Azure AD app and attribute filtering
      - Password synchronization
      - Password writeback
      - Group writeback
      - Device writeback
      - Directory extension attribute sync.
    - Enable single sign-on
      - Requires domain administrator account
    - Choose staging mode or install it
      - Staging mode: Synchronization won't synchronize any data to Azure AD
  - Post installation
    - Install AzureAD PowerShell module
      - Then enable Azure AD recycle bin

### Metaverse
- What'll be synced in the next synchronization
  - Connectors to and from on-premises Active Directory
  - Connectors to and from Azure Active Directory
- Controls what attributes from what objects from what location are available for synchronization

### Hybrid Planning

#### Sign On
- Authentication and Authorization
  - How d1. users typically login to their on-premises environment?
  - How will users sign-on to the cloud?
  - Will you be allowing workers from partner networks access to cloud and on-premises resources?
- Multi-Factor Authentication
  - D1. you currently implement multi-factor authentication?
  - What are the key scenarios that you want to enable MFA for?
  - Will you use MFA to secure Microsoft Apps?
  - Will you use MFA to secure remote access to on-premises apps?
- Delegation and Administration
  - Does your company have more than one user with elevated privilege to manage your identity system?
  - Does your company need to delegate access to users to manage specific resources?
  - Does each delegated user need the same access?

#### Synchronization
- Directory synchronization
  - D1. you have a disaster recovery plan for the synchronization server?
  - Where will the synchronization server be located?
    - E.g., if it's behind a firewall, you'll need to open up some ports
  - D1. you have any other directory on-premises like LDAP or an HR database?
  - Does your company use Microsoft Exchange?
- Multi Forest synchronization
  - Are the UPNs unique in your organization?
    - More than one forest: You can call people the same thing as other people1.  You won't be able to d1. that in single Azure AD as they need unique UPNs.
  - Will the Azure AD Connect server be able to get to each forest?
  - D1. you have an account with the correct permissions for all forests you want to synchronize with?
- Password synchronization
  - D1. you have restrictions on storing passwords in the cloud?
  - Will your employees be able to reset their own passwords?
  ### Account Lockout Policy
  - What account lockout policy does your company require?

  ### Applications
  - Will users be accessing on-premises applications? In the cloud? Or both?
  - Are there plans to develop new applications that will use cloud authentications?
    - If so, then make sure that authentication can use OAuth, certificates, etc.
  - Will cloud users be accessing applications on-premises?
  - Will on-premises users be accessing applications in the cloud?

  ### Access Control
  - Does your company need to limit access to resources according to some conditions?
  - Does your company have any application that needs custom control access to some resources?
  - Does your company need to integrate access control capabilities between on-premises and cloud resources?
  - Does each user need the same access level?

  ### Domain Structure
  #### Domain Name
  - What name will your organization use for your domain in the cloud?
  - Does your organization have a custom domain name?
  - Is your domain public and easily verifiable via DNS?

  #### Directory Structure
  - How many AD forests d1. you have?
  - How many Azure AD directories?
  - Will you filter what user accounts are synchronized with the Azure AD?
  - D1. you have multiple Azure AD Connect servers planned?
  - D1. you have different directory that users authenticate against?

  #### Federation
  - Will you use the Azure Federation or on-premises AD FS?
    - An option is moving on-premises AD FS to Azure Federation.
  - More federation services for identities are provided now through Azure
  - Does your organization use smart cards for Multi Factor Authentication?

  ### Forest to Azure AD Topology
  #### Restrictions
  - One to one relation between Azure AD and AD Connect
    - Multiple AD Connect cannot connect to Single Azure AD
    - Azure AD Connect cannot connect to multiple Azure AD directories
  - The same user account cannot sync to multiple Azure AD directories
  - Users in one Azure AD cannot appear as contacts in another Azure AD directory

  #### Single Forest to Single Azure AD
  - Single Forest 1.  Single AD Connect 1.  One Multiple AD
  - Most common topology
    - Recommended by Microsoft
  - Expected topology when using Azure AD Connect Express installation
  - Supports multiple domains

  #### Single Forest to Multiple Azure AD
  - Single Forest 1.  Multiple AD Connects 1.  One Multiple AD
  - Useful when e.g1.  some users passwords cannot be written back to the cloud but another department can d1. it.
    - Azure AD Connect sync servers must be configured for mutually exclusive filtering.
    - Users in one Azure AD will only be able to see users from their own Azure AD instance.
    - A DNS domain can only be registered in a single Azure AD directory.
    - Some write-back features not supported with this topology
      - No group / device writeback

  #### Multiple Forest to Single Azure AD
  - Multiple Forest 1.  One AD Connect 1.  One Azure AD
    - Users must have only one identity across all forests
  - The user authenticates to the forest in which their identity is located.
  - All forests are accessible by Azure AD Connect
    - Users have only one mailbox

  #### Multiple Forest to Multiple Azure AD
  - Multiple Forest 1.  Multiple AD Connects 1.  Multiple Azure ADs
  - Useful especially if you need isolation for different forests.
  - For each instance of Azure AD, you'll need an installation of Azure AD Connect
  - Users in one Azure AD will only be able to see users from their AAD instance.

  ### Register Domain Name
  #### Add Azure AD Domain Name
  - Create directory where organization name is contoso.local.
  - Add domain name azure-contoso.com and verify through TXT DNS entry.

  #### Add UPN Suffix
  - On-prem resources has name@contoso.local but you'll need name@azure-contoso.com to allow e.g1.  SSO.
  - Flow:
    1.  Add azure-contoso.com as an alternative UPN Suffix through Active Directory Domains and Trusts
    21.  Add azure-contoso.com to all user accounts as the preferred UPN suffix.

  ### Single Sign On
  #### Password Synchronization
  - A copy of password and usernames is synchronized to the cloud.

  #### Pass Through Authentication
  - You don't store passwords in cloud
  - User is authenticated using pass through authentication agent that connects with on-premises AD
  - Works seamlessly with Azure Multi-Factor authentication

  #### Seamless SSO
  - Works with Azure AD Join or the desktop is previously joined to your AD domain
  - Requires Azure service endpoints to be added to the client browser's Intranet zone.
    - This way the browser can send the Kerberos ticket to the website.
  - Flow:
    1.  Client from a joined device tries to access to a resource in cloud.
    21.  Local client goes to AD DC and gets an access token.
    31.  Client forwards access token to Azure AD.
      - If MFA is enabled, it'll prompt user.

  ### Making Cloud Apps Available
  #### Azure AD 1.  Enterprise Applications
  - 4 categories:
    1.  Gallery applications
    21.  Applications you're developing, integrated with Azure AD
    31.  On-premises applications with Azure AD Application Proxy
      - Azure AD Application Proxy
        - Allows Azure to reach on-premises resources.
        - Consistent access to private resources without a VPN.
        - Install App Proxy & Connector on-premises
          - Cannot be installed on a server with the Pass Through Authentication connector
          - You need to configure a CNAME on DNS for the particular domain work for it to work.
        - Set-up on Azure
          - Add applications
          - Assign to users
          - Configure SSO
          - Provision just like any SaaS app
        - Flow for Azure user reaching on-premises resource:
          1.  Azure AD gives a token to user
          21.  User sends that token to Azure App Proxy
          31.  Proxy takes UPN and SPN and gives it to connector
          41.  Connector goes to on-prem AD and gets Kerberos ticket.
          51.  It forwards it to actual on-prem application, it verifies the ticket and ticket is assigned to the cloud user.
    41.  Non-gallery applications

  #### Manage Permission
  - Azure AD 1.  Enterprise Applications 1.  In application 1.  Users and groups

  #### Configure SSO
  - Configure SS1. for the new application
  - Manage permission
    - Azure AD 1.  Enterprise Applications 1.  In application 1.  Single sign-on
  - Sign-on types:
    - Password-based Sign-on
    - Linked Sign-on
    - SAML
      - Provides step by step guide for federation between application and Azure AD manually
        1.  Click on the new application new in the Azure AD MyApps access panel
          - Access panel is reached at myapps.microsoft.com
          - It prompts you to install a browser extension
        21.  Install Access Panel Extension
        31.  Log into application s1. that password is stored for SSO

  ### Azure Policies
  #### Microsoft Azure Policies
  - Configures what kind of resources can be deployed and managed
  - Ensures proper cloud governance by controlling resource deployment and usage.
    - Publishing requires Microsoft.Authorization/policyassigments/write permission.
    - The assigner is saved as assignedBy property.
  - Apply to new and existing resources.
    - Resources are scanned hourly for compliance with policies.

  #### Policy Types
  - Built-in policies
    - E.g.: Require SQL Server 12.0, Allowed Storage Account SKU, Allowed Resource Types, Allowed Locations, Allowed Virtual Machine SKUs, Apply tag and its default value, Enforce tag and its value, Not allowed resource types
  - Custom Policies
    - JSON format
      - Supports logical operations (or, allOf, noneOf) and if statements.
    - Used for granular resource control
      - E.g1.  limit load balancer creation to IT admins.
    - Can be create manually or by copying existing policy from e.g1.  GitHub.
      - E.g.
        ```json
        {
          "policyRule": {
            "if": {
              "not": {
                "field": "location",
                "in": "[parameters('allowedLocations')]"
              }
            },
            "then": {
              "effect": "audit"
            },
            "parameters": {
              "allowedLocations": {
                "type": "Array",
                "metadata": {
                  "description": "The list of allowed locations for resources",
                  "displayName": "Allowed Locations",
                  "strongType": "location"
                }
              }
            }
          }
        }
        ```

  #### Policy Parameters
  - Passed to policy
  - Enable policy reuse
    - Fewer policies are required.
  - String or array

  #### Policy Effects
  - Append: Resource policy additions, e.g1.  tags.
  - Audit: Logging only, generates a warning.
  - AuditIfNotExists: Enables audit if resource does not exists
  - Deny: Denies deployment
    - Existing non-compliant resources are marked but not deleted.
  - DeployIfNotExists: If resource does not exists, deploy it.

  #### Management Groups
  - Organizes multiple subscriptions.
  - Up to 6 hierarchical levels.
  - Allows to assign policy groups
    - Subscriptions inherit settings
  - Facilitates RBAC
  - Subscriptions can be moved to other parts of hierarchy.

  #### Policy Exclusions
  - Called exclusion scopes
  - Policies can have exclusions in different scopes
  - Scopes can be e.g1.  resource groups in subscription, or VMs in resource groups.

  #### Policy Initiative Definitions
  - Groups policies into a single unit.
  - Used when a single Azure governance goal consists of multiple checks.
  - Can be assigned to resources/groups/subscriptions
  - E.g1.  Security Compliance
    1.  Check for endpoint protection
    21.  Check for VM disk encryption


## Action groups   
- Name: Unique identifier 
- Action type 
  1.  Voice call or SMS 
      1.  Up to 10 SMS / voice call actions in an action group1.  
      1.  No more than 1 SMS / Voice call every 5 minutes1.  
  1.  Webhook 
      1.  Up to 10 webhook call actions in an action group1.  
      1.  It'll retry 2 times: first after 10, then 100 seconds1.  
  1.  Logic App 
      1.  Up to 10 logic app actions in an action group1.  
  1.  Automation runbook 
      1.  Up to 10 Runbook actions in an action group1.  
  1.  Azure Function 
  1.  ITSM 
      1.  Up to 10 ITSM actions in an action group1.  
  1.  Email 
      1.  Up to 1000 e-mail actions in an action group1.  
      1.  No more than 100 emails in an hour1.  
  1.  Push notification 
      1.  Azure App Push 
          1.  Up to 10 Azure app actions in an action group1.  
          1.  Details: corresponding phone number, email address, webhooks URI, or ITSM connection details1.  


## Monitoring and reporting on spend 
Two ways to understand Azure bill to compare usage and costs (invoice): 
  1.  Using usage file 
      1.  Detailed usage CSV file shows charges & daily usage in billing period 
      1.  Download: 
        1.  Sign into the Azure account Center as the Account Administrator 
        1.  Select the subscription for which you want the invoice and usage information 
        1.  Select billing history 1.  Download usage 
        1.  Select billing history 
  1.  Using Azure portal 
      1.  Subscription 
      1.  Cost analysis 
      1.  Filter by Timespan 
  1.  See estimated costs on Portal: 
      1. Subscription 
      1.  Usage and estimated costs 


## Log Analytics 
  Old: OMS
  new: Embedded in Azure Monitor as Logs1.  
It's a dataware house for telemetry 
It converts any schema to a table schema that allows you to query  
1.  Uses KQL (pipe-based) language to query1.  
1.  All monitoring roads lead to Azure Log Analytics 
1. There's always an integration from an logging Azure component to Log Analytics1.  
1.  You can download agents in Workspace to Connect to Agents do not require VPN 
1. System Center Operations Manager 
1.  Can send data to Log Analytics from cloud/on-prem servers  
1.  Azure Data Explorer 
      1. Query language is used & viewed 
1.  Alert rule 
1. Based on each query that run on regular intervals, results are evaluated to trigger an alerto  
1. Target 
1.  Specific Aure resource 
1. Criteria 
1.  Specific logic to trigger an action 
1.  Log Alerts 
1.  Describes where signal is custom query based on Log Analytics 

1. Action 

1.  Call to send a notification 


1. Set-up in Log Analytics 1.  Alerts 


1.  Export 

1.   Excel   PowerBI 


1.  Application Insights data is used in a different partition in Log Analytics1.  

1. E.g1.  requests, traces, usages 

1. Allows you to cross application queries 


1.  Function 

1. Queries can be saved as functions to be used within another query1.  


1.  Requires log analytics workspace 


Create performance baselines 
1.  Baseline 

1. Configuration management term 



1. Signifies an agreed-upon description of product attributes, per unit time, which serves as a basis for defining change1.  

1. .1.  It's not only recommended but mandatory for team to develop a baseline1.  

1.  Gather diagnostics for long enough time1.  

1.  Capture all peaks and values over ordinary usage1.  

1.  Enable streams and create baseline 


1.  Even analyze those and agree upon which performance ranges are acceptable to define SLAs1.  

1.  Helps to isolate problem 



1.  Baselining in Azure 

i1.  Continuous monitoring 

ii1.  Normal operational parameters 

iii1.  Alerts on deviations 

iv1.  Take proactive corrective actions 


1.  Baselines actions 

1. Enable diagnostics monitoring and telemetry, e.g.: 

1.  Azure IaaS resources 

1.  Azure App Service apps 


1. Creating performance baselines 

1.  Analyze diagnostics output 

1.  Plot metrics 




 
4.1.  Storage - Azure Storage 
Storage 
Storage services 
1.  Storage account is top-level account for following services: 

1. Blob Storage 

1. File Storage 

1. Table Storage 

1. Queue Storage 



Blob Storage 
1.  Object and disk storage 


1.  Blob storage tiers 

1.  Azure Search integration 

1.  Blob Lease for exclusive write access 

1. Pass in lease id to API to modify 

1. E.g1.  IaaS VMs lease Page Blob disks to ensure its managed by single VM 


1.  You can create snapshots on blob level and view snapshots1.  


Azure Data Lake Storage 
1.  Uses blob storage to store data 

1.  Big data analytics 

1.  Analytics interface and APIs 

1.  Blob storage APIs 

1.  Hadoop compatible access to data 

1.  GPv2 Storage accounts only 


Blob Types 
1.  Block Blob 

1. Composed of 100 MB blocks 

1. Optimized for efficient upload 

1. Insert, replace, delete, blocks 

1. 1.  Up to 4.77TB max file size 

1. 1.  50.000 max blobs 


1.  Append blob 

1. Can only append blocks 

1. Ideal for log and audit files 

1. 1.  195GB max file size 


1.  Page Blob 

1. Optimized for frequent read/write operations 

1. Good for VM disks and databases 

1.  Foundation for IaaS disks 

1.  Stores VHD files1.  

1.  Underlying storage for Azure SQL 


1. 1.  Standard (HDD) / Premium (SSD) storage 

1. 1.  8 TB max file size 

1. 1.  Only offered in General Purpose account types 



Blob Storage Access Tiers 
1.  Set on blob level1.  

1.  Three tiers: 

i1.  Hot Tier: Frequent reads 

1.  Lower data access costs 

1.  Higher data storage costs 


ii1.  Cool Tier: Accessed less frequently 

1.  Higher data access costs 

1.  Lower data storage costs 

1.  Optimized for data that's stored 30 days 


iii1.  Archive Tier: Take hours to get data available 

1.  Highest data access cost 

1.  Lowest data storage cost 

1.  Optimized for data that's stored 180 days 

1.  Only supported for Block Blobs 



1.  Changing storage tiers incurs charges 

1.  Can't change the Storage Tier of a Blob that has snapshots 

1.  Azure Blob Storage Lifecycle Management Policies 

1. E.g1.  configure a policy to move a blob directly to the archive storage tier X days after it's uploaded 

1. In portal: Storage Account 1.  Blob Service 1.  Lifecycle Management 

1. Executed daily 



WORM: Write Once Read Many 
1.  Cannot be erased or modify for certain period of time1.  

1.  Set on container level 

1.  Enable in portal 

1. Access Policy 1.  Add Policy 1.  Time-based retention (set retention period) / Legal hold (attach tags) 1.  Lock policy 



Soft Delete 
1.  Saves deleted for a specified period of time 

1.  In portal: Storage Account 1.  Blob Services 1.  Soft Delete 


Static Website Hosting 
1.  When activated it creates $web container1.  

1.  You need to have default document and error page1.  

1.  You can integrate Azure CDN 

1. Azure Content Delivery Network (CDN) 

1.  Distributed network of cache servers 

1.  Provide data to user from closest source 

1.  Offload traffic from origin servers to CDN 

1.  Typically static data 


1.  Pricing tiers are Microsoft, Akami, Verizon (Microsoft partners) 

1.  Supports   HTTPS   large file download optimization  file compression   geo-filtering 

1.  Azure CDN Core Analytics is collected and can be exported to blob storage, event hubs, Log Analytics1.  


1. Azure Storage blob becomesorigin server1.  

1. Azure CDN servers become edge servers 

1. CDN can authenticate to Blob Storage with SAS tokens to be able to read private data1.  

1. Caching rules 

1.  On blobs you can set CDN caching rules, such as CacheControl:max-age=86400 in blob properties1.  


1. Tw1. alternatives to set up: 

a1.  Create CDN and configure against blob service1.  

b1.  Storage account 1.  Blob service 1.  CDN 



1.  You can have custom domain 

1.  You can have CORS policies 


Azure Search 
1.  Integrates with Blob Storage 

1.  You can provide metadata in blobs, they'll be used as fields in search index which helps categorize documents and aid with features like faceted search1.  

1. You can choose index content, content+metadata or just metadata1.  


1.  Searchable blobs can be   PDF   DOC/DOCs   XLS/XLSX   PPT/PPTx   MSG   HTML   XML   ZIP   EML   RTF   TXT   CSV   JSON 

1.  Structure 

1. Index, Fields, Documents 


1.  Data Load 

1. Push data in yourself 



1. Pull data from Azure sources (SQL, Cosmos DB or blob storage) 


1.  Data Access 

1. REST API, Simple Query, Lucene, .NET SDK 


1.  Features: 

1. Fuzzy search handles misspelled words1.  

1. Suggestions from partial inputo  

1. Facets for categories1.  

1. Highlighting search tags for the results1.  

1. Tune and rank search results 

1. Paging 

1. Geo-spatial search if index data has latitude and longitude, user can get related data based on proximity 

1. Synonyms 


1.  Lexical analysis done by Analyzers 

1.  You can combine following cognitive skills in pipelines: OCR, language detection, key phrase extraction, NER, sentiment analysis, merger/split/image analysis/shaper1.  


File Storage 
1.  SMB File Shares 

1.  Attach to Virtual Machines as file shares 

1.  Integrates with Azure File Sync 

1. On-prem to Azure sync with caching strategy 



Table Storage 
1.  NoSQL Data Store 

1.  Scheme-less design 

1.  Azure Cosmos DB 


Queue Storage 
1.  Message based 

1.  For building synchronous applications 

1.  URL format: e.g1.  http://storageaccount.blob.core.windows.net 


Account Types 
Blob Storage Account 
1.  Supported services: Blob storage 

1.  Supported blob types: Block blobs, append blobs 

1.  Supports blob storage access tiers (hot, cool, archive) 


General Purpose V1 
1.  Supported services: Blob storage 

1.  Does not support blob storage access tiers (hot, cool, archive) 

1.  Classic deployment & ARM 

1.  Does not support ZRS (Zone Redundant Storage) replication 

1.  Slightly cheaper storage transaction costs, can be converted to V21.  


General Purpose V2 
1.  Supports all latest features1.  

1. Including anything in General Purpose V1 and blob storage access tiers1.  


1.  .1.  Recommended choice when creating storage accounto  

1.  Lower storage costs than V1 

1.  Has a changing soft limit (as of now 500 TB) 

1. You can contact Azure support and request higher limits (as of now 5 PB)1.  Same for ingress/egress limits to1.  



Account Replication 
1.  Impacts SLA 

1.  Locally Redundant Storage (LRS) 

1. Three copies of data in single data center1.  

1. Data is spread across multiple hardware racks1.  


1.  Zone Redundant Storage (ZRS) 

1. Three copies of data in different availability zones in same regioNo  

1. 1.  Only available for GPv2 storage accounts 


1.  Geo-redundant Storage (GRS) 

1. Three copies of data in tw1. different data centers in tw1. different regions1.  

1. 1.  You don't get to choose second region, they're paired regions decided by Microsofto  

1. 1.  Replication involves a delay1.  



1.  RP1. (recovery point objective) is typically lower than 15 minutes1.  



1.  Read-access Geo-redundant Storage (RA-GRS) 

1. Same as GRS, but you get read-only access to data in secondary regioNo  



Azure Storage Explorer 
1.  Cross-platform client application to administer/view storage and Cosmos DB accounts1.  

1. Can be downloaded with Storage Account 1.  Open in Explorer in Portal1.  

1. Available in Azure portal as well (preview & simpler) 


1.  Can manage accounts across multiple subscriptions 

1.  Allows you to 

1. Run storage emulator in local environmento  

1. Manage SAS, CORS, access levels, meta data, files in File Share, stored procedures in Cosmos DB 

1. Manage soft delete: 

1.  Enables recycle bin (retention period) for deleted items1.  



1.  Connecting and authentication 

1. Admin access with account log-in 

1. Limited access with account level SAS 



Pricing 
1.  Data storage cost (capacity) 

1.  Data operations 

1.  Outbound data transfer (bandwidth) 

1.  Geo-replication data transfer 


Import and export data to Azure 
1.  You can use portal, PowerShell, REST API, Azure CLI, or .NET Storage SDKs1.  

1.  You can upload files/folders using Azure Storage Explorer1.  

1.  You can use physical drives 

1. 1.  64 bit only operating systems: Windows 8+ and Windows Server 2008+ 

1. Preparing the drive 

1.  NSTF only1.  

1.  Drives must be encrypted using BitLocker 


1. WAImportExportTool 

1.  Azure Import/Export tool 




1.  V1: Blob Storage, Export Jobs, V2: GP v1, GP v2 

1.  Allows you to copy from on-prem1.  




AzCopy 
1.  You can use AzCopy command-line utility tool1.  

1.  No limit to # of files in batch 

1.  Pattern filters to select files 

1.  Can continue batch after connection interruption 

1. Uses internal journal file to handle it 


1.  Copy newer/older source files1.  

1.  Throttle # of concurrent connections 

1.  Modify file name and metadata during upload1.  

1.  Generate log file 

1.  Authenticate with storage account key or SAS1.  


Importing data 
1.  Create import job 

i1.  Create storage account 

ii1.  Prepare the drives 

1.  Connect disk drives to the Windows system via SATA connectors 

1.  Create a single NTFS volume on each drive 

1.  Prepare data using WAImportExportTool 

1.  Modify dataset.csv to include files/folders 

1.  Modify driveset.csv to include disks & encryption settings 

1.  Copy access key from storage account 



iii1.  In Azure 1.  Create import/export job 1.  Import into Azure 1.  Select container RG 1.  Upload JRN (journal) file created from WAImportExportTool 1.  Choose import destination to the storage account 1.  Fill return shipping inf1. 

iv1.  Ship the drives to the Azure data center & update status with tracking number 


1.  Costs 

1. Charged: fixed price per device, return shipping costs 

1. Free: for the data transfer in Azure 


1.  No SLAs on shipping 

1. Estimated: 7-10 days after arrival 



Exporting data 
1.  In portal: Azure 1.  Create Import/Export Job 1.  Choose Export from Azure 

21.  Select storage account and optionally containers 

31.  Type shipping inf1. 

41.  Ship blank drives to Azure 

51.  Azure encrypts & copies files 

1. Provides recovery key for encrypted drive1.  



Azure Data Box 
1.  Microsoft ships Data Box storage device 

1. Each storage device has a maximum usable storage capacity of 80 TB1.  


1.  It lets you send terabytes of data into Azure in a quick, inexpensive, and reliable way 


 
4.1.1.  Storage - Azure Storage - Security 
Azure Storage Account Security 
Management vs Data Plane 
1.  Handled with RBAC in Azure AD 

1. Can see storage keys: Owner, Contributor & Storage Account,Virtual Machine Contributor, Storage Account Key Operator Service 

1.  Reader cannot see storage keys 




Management Plane 
1.  Administrative tasks e.g1.  

1. Viewing properties of storage accounto  

1. Deleting storage accounto  

1. Assigning roles to other users1.  

1. Modifying the configuratioNo  



Data Plane 
1.  Requires access to storage account keys1.  

1.  On blobs you can set access level to public access1.  


Storage Account Keys** 
1.  Provides full access to the storage 

1.  .1.  Best practice: Give all admins and apps same key1.  

1. Enables you to: 

1.  Regenerate secondary key1.  

1.  Update apps to use secondary key 

1.  Regenerate primary key 



1.  Can be managed by Azure Key Vault using Powershell 

1. Storage account keys are stored as Key vault secrets1.  

1. Azure Key Vault syncs keys with storage Account 

1. Storage account keys never returned to caller1.  



Shared Access Signatures (SAS tokens) 
1.  .1.  Better as it follows principle of the least privilege1.  

1.  Contains permissions and start & end validity period1.  

1. Set read and/or write permissions1.  

1. Grant permissions to access only partition + row key ranges1.  

1. You can restrict access to IP Address(es) 

1. Enforce HTTPS 


1.  Tw1. types: 

1. Service Level SAS: Only to a single blob/file/table or queue storage1.  

1. Account Level SAS: Applies to multiple services 


1.  It's generated by client and is not tracked by Microsofto  

1. Signature is signed with account key and ensures none of the parameters are tempered1.  

1. to invalidate, you'll need to regenerate storage account key used to sign SAS1.  

1. .1.  Better way: Storage Access Policies 

1.  Defined on container level1.  




1.  In portal: Containers 1.  Right click on container 1.  Access policy 


1.  Permissions + validity period is on server side1.  

1.  Service level SAS only1.  

1.  Easy to revoke by deleting the policy or changing its validity period1.  



1.  Example url: 


URL part 
 Description 
 
https://myacount.blob.core.windows.net/container1/file1.pdf 
 URL to endpoint 
 
?sv=2017-07-29 
 Rest API version 
 
&st=2018-04-30T19%3A19%3A19Z 
 Validity start time 
 
&se=2018-05-01T19%3A19%#A19Z 
 Validity end time 
 
&sr=b 
 Type of resource 
 
&sp=r 
 Permissions 
 
&sip=168.1.5.60-168.1.5.70 
 IP Address / range (optional) 
 
&spr=https 
 Protocol (optional) 
 
&sig=pk9oGEPqYyu0K4Gutfreq9n0CJqgnjYgkEwcIEL8I0%3D 
 Signature 
 

Azure AD authentication with RBAC 
1.  Available for Blob and Queue services1.  

1.  Azure AD provides OAuth 2.0 token 

1.  E.g1.  Storage Blob Data Contributor, Storage Blob Data Reader, Storage Queue Data Contributor, Storage Queue Data Reader 

1.  Subscription level (for all Storage Accounts), Resource group level, Storage level or Blob container/queue level1.  

1.  For users, groups, applications, managed service identities1.  

1.  You register your application in AD (App Registrations) 


1. You can then assign roles to your applicatioNo  

1. Roles can als1. be assigned to Managed Service Identity (MSI) 

1.  Can set up with Azure VMs, Function Apps, VM Scale Sets 

1.  Credentials are injected into service instance (e.g1.  client id and certificate) 

1.  Code calls local MSI endpoint to authenticate to the resource (e.g1.  storage) 



1.  Easier management, No need to handle SAS tokens or manage keys1.  


Encrypt data in transit 
1.  Enforced by enabling Secure Transfer 

1. Requires HTTPS for REST API 

1. Requires SMB 3.0 for Azure file service 


1.  When moving data e.g1.  between 

1. Azure regions 

1. On-prem to Azure storage 

1.  You can use Site-to-Site VPN, Point-to-Site VPN or Azure ExpressRoute1.  



1.  The data is moved across interneto  

1.  .1.  Vulnerable to Azure, good to encrypt data1.  

1. Configuration from outside Storage Account always requires SMB 3.0 

1. SMB 2.1 does not have encryption s1. it's only allowed between different Azure regions1.  

1. Secure transfer required option is disabled by defaulto  


1.  SAS tokens can specify only HTTPS can be used1.  

1.  You can als1. use client side encryption 

1. Encrypt data within the applicatioNo  

1. Double encrypted as Azure storage encrypts data as defaulto  

1. Still good idea to enforce HTTPS 

1.  HTTPS has built-in integrity checks to avoid network data loss 


1. There are SDKS for e.g1.  C#, JAVA1.  

1. Can leverage Azure Key vault to generate and/or store keys1.  



Encrypt data in rest 
1.  Every storage account has encryption enabled by default and cannot be disabled1.  

1.  Required for many compliances e.g1.  privacy1.  


Storage Service Encryption (SSE) 
1.  Encrypts data before it's written 

1.  Decrypts data before it's read 

1.  Allows you to get encryption without any code 

1.  Applies to Standard and Premium1.  

1.  Uses 256 bit AES1.  

1.  Keys are managed by Microsoft by defaulto  

1.  Allows you to use your own encryption keys1.  

1. 1.  Blobs and files only1.  

1. 1.  Can only enable after the account is created1.  

1. 1.  Key vault and storage account must be in same region 

1.  Can be in different subscriptions 




Azure Disk Encryption 
1.  Encrypts data disks (VHD) of VMs1.  

1.  Handles both managed & unmanaged disks1.  

1.  Windows VMs: BitLocker encryption 

1.  Linux VMs: DM-crypt 

1.  Integrates with Key Vault to manage keys1.  

1. 1.  Key Vault must reside in same region and subscription 

1. When uploading encrypted VM, you can upload encryption keys to Azure Key Vault firsto  

1.  Good for migrating as you can use same keys as on-premises1.  




Configure network 
1.  By default, storage accounts are accessible by all networks including internet 

1.  Allows you to create trust boundaries 

1.  Setting up networking/firewall rule 

1. 1.  Denies all traffic by default unless any connection are explicitly opened 


1.  In portal: Settings 1.  Firewalls and Virtual Networks .Select Network 

1.  You can have VNets from the same region as storage account or in a paired regioNo  

1.  Firewall allows you to choose IP addresses that can access VMs 

1. E.g1.  you can set up only ExpressRoute access1.  


1.  When you configure Azure Storage firewalls and virtual networks 


 
4.1.21.  Storage - Azure Storage - Monitoring 
Monitoring 
Activity Log Monitoring 
1.  Management logs: 

1. Role assignments 

1. Regenerating Storage Account keys 

1. Changing Storage Account settings 


1.  Not data plane logs e.g1.  new blob added, they're diagnostic logs 


Activitiy Log Events 
1.  Types include:   Administrative events   Service health events   Autoscale events   Recommendations   Security alerts   Alerts 

1.  Stored for 19 days 

1.  Archival possible 

1. to Storage Account 

1. to Event Hub 



Storage Analytics 
1.  Type of diagnostic logs 

1. Enabled in Diagnostic settings 


1.  Retention period up to 365 days1.  

1.  Contains 

1. Details of read, write, and delete operations 

1. Reasons for failed requests 


1.  Issues can be found through monitoring or reported by users 

1.  Data includes:   Type of Operation   Success or Failure   Object Key   HTTP Status Code   Start Time   Server and E2E Latency   Authentication Type   IP Address of Caller   Browser Information   Type of Client   Client Operation ID   Server Operation ID 

1.  Write blobs to blocks immediately 

1. 1.  Can take an hour until available as flush is waited1.  

1. Search +/- 15 minutes and based on log metadata 


1.  20 TB limit, independent of Storage Account total limito  


1.  You can download Microsoft Message Analyzer and analyze logs in a good UI instead of text files1.  


Storage Analytics Metrics 
1.  Enabled as default 

1.  Integrates with Azure monitor 

1. 1.  Data is stored 30 days1.  


1.  Setting up alerts 

1.  Sends 

1. Capacity metrics 

1.  For both storage accounts and individual storage services 

1.  Sent to Azure monitor every hour 

1.  Values are refreshed daily 


1. Transaction metrics 

1.  Successful, failed, errors 

1.  Ingress/Egress of data 

1.  Service availability 


1. Performance metrics: Server latency, E2E (end-to-end) latency 


1.  Metric dimensions: Response type, API calls, authentication type, geotype 


Monitoring costs 
1.  Estimating costs 

1. Azure Pricing Calculator 

1. Azure Total Cost of Ownership (TCO) Calculator 

1.  Calculate the cost savings by migrating from on-premises to Azure 



1.  End of month bills 

1. Invoice, detailed usage CSV file 



Azure Cost Management 
1.  Detailed cost analysis 

1. Consumption, cost, performance 

1. In portal 

1.  Open scope (e.g1.  subscription or resource) 1.  Click on code analysis blade 

1.  Or g1. to "Cost Management" 1.  "Cost analysis" and change scope on top 



1.  Resource optimizations 

1. Identify underutilized resources 



1.  Budgets, alerts, action groups 

1. Compare costs against budget 


1.  Cross-cloud 

1. Manage Azure, Amazon and Google cloud resources in one tool1.  


1.  In portal can be found 

1.   Replaces Cloudyn that was a third party cost management service which was acquired by Microsoft in 2017 and integrated in Azure Cost Management, Cloudyn is deprecated since 2020 but existing users can still user1.  


Monitoring costs using portal 
1.  In Subscription 1.  Cost Analysis 

1. Filter, view consumptions per resource/tags etc1.  


1.  Subscription 1.  Invoices 

1. Shows invoices 

1. 1.  It does not show individual resources1.  

1.  to see them g1. to: Subscription 1.  Manage and download invoices 




Monitoring costs using Azure Billing APIs 
1.  Non-enterprise customers 

1. Azure Resource RateCard API 

1.  Pricelist across different regions/currencies 


1. Azure Resource Usage API 


1.  Enterprise customers 

1. Balance and Summary API 

1. Usage Details API 

1. Marketplace Store Charge API 

1. Price Sheet API 

1. Billing Periods API 



 
4.21.  Storage - Azure Files 
Azure Files 
1.  99.9% SLA with availability, redundancy and disaster recovery1.  

1.  Typical use cases: 

1. Lift and shift 



1. Hybrid solutions 

1. Born-in-cloud applications that require shared storage are 

1. Storage for cross-platform solutions 

1. Any workload that currently uses a file server or NAS providing SMB access 


1.  REST compatible 

1.  SMB-compatible 

1. File protocol over port 445 

1. Can be mounted by Linux & windows & macOS compatible 

1. Versions 

1.  SMB 1: Limited block sizes, chatty protocol 

1.  SMB 2.1 (Supported by Azure) 

1.  No encryption 

1.  Better network performance than SMB 1.0 

1.  Group file shares, software shares 

1.  Supported >Windows 7, > Windows Server 2008 


1.  SMB 3 (Supported by Azure) 

1.  Active-active support: Clustering with nodes 

1.  Transparent failover 

1.  RDMA support, multi channel > Lower latency 

1.  Enables usage of SQL and Hyper-V 

1.  Encryption support 

1.  Supported > Windows 8, > Windows Server 2012 



1. Talks through port 445 and outbound connection 


1.  Create Azure File Share 

1. Multiple Azure File shares can be created under a storage account 

1. Each has a name and optional quota assigned 

1.  Quota limits the size up to 5120 GB 


1. In portal: Storage 1.  Files 1.  File Share 


1.  File access 

1. Access is via standard SMB client 

1. Dialect of SMB is negotiated between the client and Azure Files upon connection 

1. Encryption used if outside the Azure region or if required as part of the storage account configuration 

1. SMB access utilizes the storage account name (as user name) and access key (as password)1.  

1. REST access can utilize SAS tokens 



Azure File Snapshots 
1.  Delta snapshot of a file share 

1.  Read-only, you can download your snapshot or mount ito  

1.  Azure Backup can schedule and manage snapshots 

1.  200 snapshots per file share 

1.  If the file share is deleted all snapshots are als1. deleted 


Replication options 
1.  DFS-R (before it was File Replication Service) 

1.  xcopy, robocopy 

1.  Considerations: locking of files, data consistency, amount of data replicated and maintaining ACLs1.  


Azure File Sync 
1.  Enables replication from a single Azure Files share to one or more Windows based file servers 

1. Windows service are in a synchronization group1.  


1.  Utilizes an agent deployed on each Windows Server instance that's then registered with the Storage Sync service then added to a sync group1.  


Cloud tiering 
1.  Least used data is moved to the cloud 

1. Leaves a thumbprint on the server providing transparent access 

1. Data is pulled down when access is requested1.  


1.  Tiering is based on maintaining a certain percentage of free space1.  

1. Ensures around 20% is always free in file server1.  


1.  Can be disabled 

1.  Is scoped to a file sync namespace1.  

1.  File must be higher than 64 KB 


Quality of Service (QoS) 
1.  Default configuration: Server will consume maximum possible bandwidth for data transfer via the storage sync service1.  

1.  Supports network limits to be configured 

1.  For a VM based file server, QoS of the hypervisor can be used1.  


Considerations 
1.  Avoid actions that'd cause data to be pulled down from the cloud 

1. E.g1.  anti-virus scans, backups on-premises 


1.  ACL (Access Control Lists) are replicated to the cloud but are not enforced when accessed via Azure Files1.  

1. .1.  Content should be restored to an IaaS VM file server to enable ACL enforcemento  


1.  Data can be pre-seeded via Azure Databox with some caveats 

1. Enables pre-seeding instead of full copy over the network1.  


1.  Be careful when combining other data replication technologies1.  


Workflow for replication 
1.  Deploy a storage account 

21.  Deploy a Azure File Share 

31.  Deploy Storage Sync service 

1. Must be in same region as storage account 


41.  Create a sync group 

1. Sync group has: 

1.  Storage account & file share 

1.  Server endpoints 

1.  Cloud endpoints 



51.  Register server 

i1.  On portal: Sync Service 1.  Registered Service 1.  Download Azure File Sync Agent 

ii1.  Install the service and register the server 


61.  Add file share into the sync group as server endpoint 

1. .1.  You can have only 1 cloud endpoint for the same sync group 

1. You can enable/disable cloud tiering 


71.  Install agent on file server 

1. Supported >Windows Server 2012 

1. Selected files can be skipped 


81.  Register server to the storage sync service as server endpoint 


Scale and Limits 
1.  15 storage sync services per subscription 

1.  30 sync groups per storage service 

1.  1 cloud endpoint and 50 server endpoints per sync group 


1.  4 TB maximum space 

1.  100 GB maximum file size 

1.  64 KB minimum file size to be tiered 


Troubleshooting 
1.  Check if TCP 445 is open for outbound traffic1.  

1.  In metrics you can monitor for problems1.  

1.  On portal 

1. In Sync Services 1.  Sync Groups 1.  Group 1.  See health status and action recommendations for problems for cloud and server endpoints 


1.  In Event Viewer you can check FileSync events 


 
4.31.  Storage - Azure Backup 
Azure Backup 
1.  Backs up to Recovery Services Vault 

1.  Online storage entity in Azure used to hold data such as backup copies, recovery points and backup policies1.  

1.  Storage account is automatically created an configured 

1. Comes with LRS and GRS storage account 

1.  Configure in Vault 1.  Backup Infrastructure 1.  Backup Configuration 



1.  All backups are listed and globally controlled in Backup Jobs 

1. You can monitor status and get reports 

1. You can filter the jobs 


1.  Backup policy 

1. Settings 

1.  Policy type 

1.  Azure VM 

1.  Azure File Share 

1.  SQL Server in Azure VM 


1.  Backup frequency 

1.  Retention range: daily, weekly, monthly, yearly 



1.  You can set inbuilt RBAC roles to vault 

1. Backup Operator 

1.  Manage backups but cannot remove backup, create vault, give any roles1.  


1. Others e.g1.    Backup Reader   Monitoring Reader 



1.  Backup Alerts 

1. Vault 1.  Backup Alerts 1.  Configure notifications 1.  Enable e-mail notifications 1.  Choose severities (critical, warning, information) 1.  Select notification (per alert or hourly digest) 


1.  Enable MFA 

1. Properties 1.  Security settings 1.  Enable 

1. 1.  Cannot be disabled when enabled once1.  


1.  You generate Security PIN for critical options and Azure Backup will prompt for the pin (Properties 1.  Security settings) 

1.  When creating a VM back-up you can enable back-ups and choose a vault and policy1.  

1. 1.  VM must be in same location as recovery vault 


1.  to delete a vault, ensure all backups are stopped, delete backup agents/servers 

1.  Azure Backup Reports 

1. On portal: Vault 1.  Backup Reports 1.  Diagnostic Settings 1.  Turn on diagnostics 

1. You can save reports in you can archive reports in storage accounts, stream to event hubs, send to Log Analytics 

1. After you configure a storage account for reports by using a Recovery Services vault, you can connect Azure Backup from Power BI and get a dashboard1.  



Benefits 
1.  Automatic storage management 

1.  Unlimited scaling 

1.  Application-consistent backup 

1. Each and every recovery point it has information for what it needs to g1. back to recovery point 


1.  Data encryption both in-rest and and in-transit 

1.  Unlimited data transfer 

1.  Long-term retention without any time limit 


Pricing 
1.  Pay as you g1. storage model 

1.  You pay per Protected Instance 

1. Protected instance is an application server/workload or computer that's been configured to back up to Microsoft Azure 



Components 
Microsoft Azure IaaS VM Backup 
1.  Features 

1. Policy-driven backup and retention 

1.  Scheduled and on-demand backups, multiple recovery points 

1.  You can hwoever use to backup directly with Backup Now 


1. Application-consistent backup 

1.  No impact on production environment and No shutdown of VMs 


1. Fabric level backup 

1.  Multiple backups, centralized management, detailed tracking 



1.  New VM created by backup won't have backup policy associated with ito  

1.  Restoring and file-recovery manually 

1. G1. to back-up blade for VM1.  

1.  Tw1. alternatives: 

a1.  Back-up items 1.  Select backup 1.  Restore VM 1.  Select snapshot 

b1.  VM 1.  Back-up 



1. Different alternatives: 

a1.  Restore VM 

1.  Tw1. alternatives: 

a1.  Create new VM 

b1.  Restore disks 



b1.  File recovery 

 1.  Select recovery point 

a1.  Download script and execute on VM 

1.  Mounts disks from the selected recovery point 

1.  .1.  If files are larger than 100 GB, restore whole VM instead 


b1.  Unmount disks after recovery 





Microsoft Azure Backup MARS Agent 
1.  Called als1. Recovery Services Agent 

1.  For backing up on-premises computers to Azure 

1. Install back-up agent on local machine 

1. Need connectivity to Microsoft Azure 


1.  Same configuration and control 

1. Centralized management of all on-premises back-ups 


1.  Secure backup and recovery 

1. Protected Instance is registered with Azure 


1.  Flow 


i1.  In recovery services in portal 

a1.  Back-up 

1.  Where is your workload running: On-premises 

1.  What d1. you want to back-up: 

1.    Files and folders   Hyper-V   VMware   Microsoft SQL Server   Sharepoint   Exchange   System State   Bare Metal Recovery 



b1.  Backup files and folders and system state 

c1.  Download Recovery Services Agent from link provided 

d1.  Download credentials to enter in the workstation 

e1.  Transfer credentials & agents to the workstation 


ii1.  Install the Azure backup client 

1.  Select a password for encryption 


iii1.  Setup the backup 

1.  Click on Schedule Backup in agent 

1.  Select files/folders 

1.  Specify retention settings and policy 


iv1.  Backup and restore file 

1.  Click on Backup Now in agent 

1.  Click on Recover Now in agent 




Microsoft Azure Backup Server 
1.  Centralized installation 

1. Can be installed on a server in Azure or on-premises 


1.  Free 

1.  Similar functionality as Data Protection Manager (DPM) 

1.  Backup a variety of instances 

1. Workloads, VMWare and Hyper-V VMs, hosts, files, application workloads and barebone backups 


1.  Flow 

i1.  Create Backup in Site Recovery Service 

1.  G1. to Vault 1.  Backup 

1.  Get link for Azure Backup Server 


ii1.  Install Azure Backup Server 

1.  Installs SQL server 


iii1.  Configure Azure Backup Server 

a1.  Select management 

b1.  Protection Servers 1.  Register a server 




c1.  Disk Servers 1.  Add a disk for configuration files 

d1.  Create protection group 

1.  Add servers, workstations and workloads to the group 

1.  Can back-up to online and/or locally 


e1.  Enable disk for backup data 


iv1.  Recover with Azure Backup Server 

1.  Select server 1.  Click on Recover Now 




 
51.  Compute - Virtual machines (VMs) 
Virtual Machines (VMs) 
Concepts 
1.  Storage resource provider (SRP) 

1. Disks (blob) 

1. Storage account 


1.  Compute resource provider (CRP) 

1. VMs 


1.  Networking resource provider (NRP) 

1. NICs, IP addresses, subnets load balancers.1.  



Common VM Operations 
Moving a VM 
1.  Helps for 

1. high availability 

1. reduce latency for serving from VMs closer to users 


1.  .1.  You can move virtual machines with the managed disks & in Availability Zones across subscriptions and VMs1.  

1. 1.  Not supported: 

1.  Virtual Machine Scale Sets1.  

1.  Virtual machines created from Marketplace resources with plans attached 



1.  to move a virtual machine with a network interface card, you must move all dependent resources1.  


1. E.g1.    virtual network for the network interface card   all other network interface cards for the virtual network   VPN gateways 


1.  Virtual networks (classic) can't be moved1.  

1.  Can move across regions using 

1. Azure Resource Mover 

1. Using Azure Site Recovery by copying the data 



Stopping a VM 
1.  Deallocation 

1. 1.  If you shut down a VM inside VM, Azure still keeps the resources 

1.  .1.  Deallocate instead 



1.  Auto shutdown 

1. VM blade in Portal 



Removing a VM* 
1.  Deleting VM doesn't remove dependencies such as NICs, storages, OS/data disks, IP addresses 

1.  .1.  Delete resource group instead, or use taxonomic tags 

1.  PowerShell or CLI allows you to keep OS and/or Data disks 


Azure VM Extensions 
1.  Extends VM capabilities 

1.  Requires Azure VM Agent (different for Windows or Linux) 

1. Marketplace images already have it 

1. For lift & shift, install agent first before uploading to cloud 


1.  VM Access 

1. Backdoor to reset VM password reset 

1. Allows to modify RDP/SSH configurations 


1.  VM Backup 

1. Allows to back-up VMs and configurations to recovery vault 


1.  Custom Script 

1. Allows Desired State Configuration (DSC) 

1.  You can script in Linux (bash), Windows (PowerShell) 

1.  Puppet, chef etc 



1.  Microsoft Monitoring Agent 

1. Onboards VM in Log Analytics 



Sizing 
1.  Allows vertical scaling, e.g1.  CPU, RAM and other resources 

1.  Resizing requires rebooting VM1.  

1.  Azure Compute Unit (ACU) 

1. Standardization without any hardware details 

1. 100 ACU = Small (Standard A1) VM 

1.  A = Family 

1.  1 = Size (versioned) 


1. DS_V3 = 160-190 ACU 

1. Good for estimating for lift and shifto  

1. As you raise ACU, per minute runtime charges increases1.  


1.  Types 


Type 
 Sizes 
 Description 
 
General purpose 
 B, Dsv3, Dv3, DSv2, Dv2, DS, D, Av2, A0-7 
 Balanced CPU-to-memory ratio1.  Ideal for testing and development, small to medium databases, and low medium traffic web servers1.  
 
Compute optimized 
 Fsv2, Fs, F 
 High CPU-to-memory ratio1.  Good for medium traffic web servers, network appliances, batch processes, and application servers1.  
 
Memory optimized 
 Esv3, Ev3, M, GS, G, DSv2, DS, Dv2, D 
 High memory-to-CPU ratio1.  Great for relational database servers, medium to large caches, and in-memory analytics1.  
 
Storage optimized 
 Ls 
 High disk throughput and IO1.  Ideal for Big Data, SQL and NoSQL databases1.  
 
GPU 
 NV, NC, NCv2, NCv3, ND 
 Specialized virtual machines targeted for heavy graphic rendering and vied1. editing, as well as model 
 

Type 
 Sizes 
 Description 
 
training and inferencing (ND) with deep learning1.  Available with single or multiple GPUs 
 
High performance compute 
 H, A8-11 
 Our fastest and most powerful CPU virtual machines with high-throughput network interfaces (RDMA)1.  
 

Disk Types 
1.  OS Disk 

1. 1.  Generation 1.  VHD only 

1.  If you use Generation 2 Hyper-V you need to convert from .vhdx to .vhd1.  


1. Registered as SATA drive 

1. 1.  Maximum capacity of 1 TB 


1.  Data Disk 

1. Dependent # on VM instance size 

1. Registered as SCSI disk 

1. 1.  Max capacity 4 TB 


1.  Temprorary Disk 

1. D: or /dev/sdb1 

1. Bound to the hardware host 

1. D1. not store permanent data! 



Storage 
Standard vs1.  Premium Disk Storage 
1.  Standard Disks 

1. Backed by cost-effective HDDs 

1. High availability: several replication options 

1. Stored in Azure storage account 

1. Standard SSD available for managed disks (dev/test/entry elvel production applications) 

1. Standard storage provides maximum IOPS values for each VHD 

1. On portal 



1.  You can see disks in Azure Disks1.  

1.  Azure names managed disks like dc1_data-disk1, dc1_OSDisk for a VM named dc1.  

1.  By clicking on it, you can manage the disk1.  

1.  You can e.g1.  export, create a snapshot 




1.  Premium Disks 

1. Backed by high-speed SSDs 

1. IOPS values are predictable, expected performance levels 

1. Pre-pay for all storage used (fixed sized disk sizes) 

1.  .1.  Predictable speed and IOPS 

1.  P10, 128 GB, 500 IOPs, 50 MB/sec 


1. 1.  Supports only Generation 1 VHD 

1.  If you use Generation 2 Hyper-V you need to convert from .vhdx to .vhd1.  

1.  .1.  Azure Site Recovery migration handles this automatically 

1.  On portal 

1.  You can see unmanaged disks in Blob Containers 1.  VHDs 1.  you see VHDs 

1.  A security problem is that someone by mistake can give public access to the blobs in the storage accounto  





Managed vs1.  unmanaged Disk Storage 
1.  Unmanaged Disks 

1. Original method to store VM VHDS 

1.  Legacy 


1. VHDS are stored as page blobs in an Azure storage account 

1. 1.  Maximum 256 TB of storage per VM 

1. 1.  You need to manage storage account availability 

1. 1.  20,000 IOPS limit across all VM disks in a standard storage account 

1. In storage account they're in Blob Containers 1.  VHDS container1.  

1.  They're leased 

1.  They a re locked 

1.  You need to stop & deallocate VMs to delete them 


1.  You can break lease in Storage Explorer by right clicking 



1.  Managed Disks 

1. .1.  Always use 

1. Azure manages the disks, you don't have to worry about storage account-level IOPS restrictions1.  

1. Pre-pay for disk size (No need for SA) 



1.  S10, 128 GB, 500 IOPS, 60 MB/sec 


1. Supports Standard and Premium SSD and Standard HDD 

1. 1.  LRS replication only for Premium managed disks 

1. 1.  You can resize only when they're unattached or owner VM is stopped & deallocated 



Costs 
1.  Use Azure Pricing Calculator 

1.  Optimizing costs 

1. .1.  Reserved Virtual Instances are the cheapest optioNo  

1.  You pay 1 to 3 year term for a particular VM instance size in aspecific regioNo  


1. .1.  Reuse on-prem Microsoft licensens, up to 49% discount 


1.  VM Chooser (azurevmchooser.kvaes.be) 

1. Open source applications to get recommendations 

a1.  Give total VCPUs, RAMs etc1.  

b1.  Select a recommended VM 

c1.  VM optimizer: Choose usage patterns, region etc1.  




IP addressing 
1.  You always have a private IP and you can optionally have a public IP 

1.  Public IP addresses 

1. Best practice is to never have a public IP 

1.  Consider a load balancer to map the private IP1.  


1. First 5 public IPs are free then it costs 

1. You have to NSG with an public IP 

1. Public IPv4 addresses can be associated with: 

1.  VM vNICs, public load balancers, VPN gateways, and application gateways 


1. Public IP Address SKUs 

1.  Basic SKU 

1.  Open by default 

1.  Static or dynamic allocation 


1.  Standard SKU 

1.  Secure by default (NSG) 

1.  Static allocation only 

1.  HA: Availability zone aware, can span to different availability zones 




1.  DNS Naming 


1. For VMs you can configure & use host name 

1. VM -> Overview -> Configure DNS Name then you can have like somename.eastus2.cloudapp.azure.com 



Monitoring 
Boot Diagnostics 
1.  Periodic screenshots of the console 

1.  Enables serial console 

1. You can connect to VM when you can't SSH/RDP for fixing e.g1.  boot state 

1. Requires you to have VM Contributor or higher privileges1.  

1. No need to open SSH/RDP ports 



Guest OS diagnostics 
1.  Requires storage account 

1.  Event logs, performence counters etc1.  

1.  Lowest level IaaS monitoring extension 

1.  For more diagnostics: 

1. Windows: AzurePerformanceDiagnostics 

1. Linux: Linux Diagnostic Extension (LAD) 3.0 



Azure Log Analytics 
1.  Enabled by deploying the Microsoft Management Extension 

1.  Onboards VMs into Log Analytics workspace 


System Center Operations Manager (SCOM) 
1.  Hybrid cloud approach 

1.  You can track your cloud VMs on on-premises or visa versa 


 
5.1.  Compute - Virtual machines (VMs) - High Availability 
High Availability 
1.  High Availability = Redundancy 

1.  Layers of availability 

i1.  Hardware-level availability 

1.  Handled by Azure 


ii1.  Server-level availability 

1.  Availability Sets 

1.  Ensures 99.95% SLA for VMs in availability set 

1.  Provides server level fault tolerance within a single data center within a single regioNo  

1.  Availability sets are containers/racks that's called Fault Domains1.  

1.  2 VMs in same Availability Sets = Azure places those in different availability sets1.  

1.  Update domains are different domains in different availability sets (fault Domains) and your VMs are set in different update domains as well1.  

1.  Protects availability against VM shutdowns because of update failures / hardware shutdowns1.  


1.  Must assign availability set at VM deployment 

1.  Scaling (resizing) requires stopping all VMs in the availability seto  

1.  For single VM not in availability set you have 99.9% availability if you use premium storage1.  



iii1.  Datacenter-level 

1.  Availability Zones 

1.  Allows you to place redundant VMs in different regions1.  

1.  Provides data center level tolerance1.  

1.  Load balancers are availability zone aware on standard SKU 

1.  You have to use managed disks 



iv1.  Region-level 

1.  You need recovery service vault (storage for back-ups/replications) 

1.  VM backup 

1.  Ad-hoc or scheduled 

1.  Includes all disks and configurations 


1.  Azure Site Recovery 

1.  Failover recovery 

1.  15 minute RP1. (recovery point objective) 

1.  Azure-to-Azure (A2A) ASR Architecture 

1.  Directly available in VM blade 








1.  All storage data, VMs, disks (managed and unmanaged), subnets etc1.  

1.  Prepared and ready to g1. in another regioNo  

1.  In sync 

1.  May require configuration with IP addresses 

1.  You can failover to it and/or failback 



1.  Configure in VM blade -> Disaster recovery 

1.  Allows you to configure disaster recovery for single VM 

1.  For workloads including multiple VMs you should configure it directly from Site Recovery 


1.  You can choose to automate what happens using Automation runbooks1.  

1.  You can then view recovery status in same blade 

1.  Replication health 

1.  Recovery points 

1.  Crash-consistent: 









1.  Least preferable 

1.  As if VM is replicate while it was powered off, No guarantees 

1.  App-consistent 









1.  Preferable point to recover 

1.  Data and OS back 

1.  Commit -> Finalizes the failover 

1.  Re-protected -> Creates new recovery environment from old recovery environment (which becomes source environment) 




1.  Migration to Azure 

1.  On-premises to Azure 

1.  AWS to Azure 







Azure Advisor 
1.  Gives recommendation regarding high availability 

1.  E.g.: 

1. Add more virtual machines for improved fault tolerance (medium impact) 

1. Enable VM backup to protect your data from corruption and accidental deletion (medium impact) 

1. Create an Azure service health alert (low impact) 



VM Events 
1.  Planned maintenance events 

1.  Unexpected downtime events 

1.  Notification 

1. In Azure support webpage, status webpage, twitter account 

1. Administrators get e-mail notifications 



 
5.2 Compute - Virtual machines (VMs) - Deployment 
Deployment 
1.  Deployment tools 

1.   Azure portal   Azure Cloud Shell   Azure PowerShell   Azure CLI   Azure SDKs   ARM templates 


1.  You can create from 

1. User images 

1.  Uses unmanaged disks 


1. Marketplace images 



Create VM Image 
Generalizing VM 
1.  Should be the first step 

1.  Generalization resets server-specific data: Computer name 

1. Security identifiers (SIDs) 



1. Local administrator/root identity 

1. Device driver cache 

1. Event logs 


1.  How to generalize 

1. On Windows use sysprep, "System Preparation Tool" 

1. On Linux run sud1. waagent -deprovision+user 

1. Take a VM backup first, because generalization is destructive and permanent 



Create VM image from Azure VM 
1.  Managed Disk Concepts 

1. Disks 

1.  No storage account (management) required 

1.  Pay for pre-allocated storage (P10 =128 GB SSD VHD) 


1. Snapshots 

1.  Read-only full copy of a managed disks 

1.  You can create new VMs based on snapshots 


1. Images 

1.  Generalized VM disk images 

1.  Snapshots can be converted into images 



1.  Flow 

i1.  Get an image 

1.  Get a snapshot image 

a1.  G1. to Disks 1.  Select OS disk 1.  Create snapshot 

b1.  In snapshot 1.  Click on Export 1.  You will get SAS url 1.  Download VHD 

c1.  Generalize the image 


1.  Or capture an image 

1.  In portal: VM 1.  Overview 1.  Capture 

1.  Not generalized 

1.  It appears in images 



ii1.  G1. to Images in portal, select the image, from there click on Deploy and it'll navigate you 



VM Connection 
1.  You have different levels of security NSG, host firewall, options to have public IP or not 


Just-in-time VM Access 
1.  Allowed by Azure Defender (formerly known as Azure Security Center Standard tier) 

1.  Locks down all administrator ports as default, when admin requests admin session then session is bounded by time limit and IP address restriction while granting access1.  

1.  No need to have management port open all the time 

1.  .1.  Recommended to enable 


Deploying Linux Server VM 
1.  Around 40% of workloads in Azure runs on Linux 

1.  Endorsed in Azure: CentOS, CoreOS, Debian, Oracle Linux, Red Hat Enterprise Linux, SUSE Enterprise Linux, openSUSE, Ubuntu 

1.  Connection 

1. Secure Shell (SSH) 

1.  A popular client is PuTTy for SSH or you can install subsystem for Linux or git tools on Windows 10 to get SSH1.  


1. Remote Desktop Protocol (RDP) 

1.  You can install RDP on Linux1.  

1.  Some d1. not believe in graphical shell: 

1.  Presents security vulnerability possible 

1.  Needlessly consumes CPU 


1.  Windows team ported RDP into linux1.  


1. Serial Console 

1.  COM1 serial port connection to VM 

1.  Low-level access 

1.  Helpful when e.g1.  your VM doesn't boot up 



1.  Authentication 

i1.  SSH Public Key 

1.  You keep private key and share public key with Azure1.  


ii1.  Password 

1.  You can reset those after deployment in portal: VM 1.  Reset password 




Deploying Windows Server VM 
1.  Windows Server 2019, 2016, 2012, 2008, Windows 10 Pr1. or Enterprise (for e.g1.  load testing, client-side testing, jump-box) 

1.  Connect 

1. Remote Desktop Protocol (RDP) 



1.  Uses TCP 3389 

1.  You can connect directly from Portal: Overview 1.  Connect 


1. WinRM (PowerShell) Remoting 

1.  TCP 5985, 5986 


1. Serial Console 

1.  Text console into VM 

1.  Can get to VMs that can't boot 




Prepare environment with Azure Policy 
1.  RBAC vs Azure Policy 

1. RBAC 

1.  Focuses on user actions at different scopes 

1.  VM Contributor can manage only VM 

1.  Built-in custom roles 


1. Azure Policy 

1.  Focuses on resource properties during deployment for already existing resources 

1.  Uses default allow and explicit deny access system 


1. Difference 

1.  You're not going to be able to create VM unless you have read & write abilities by RBAC 

1.  Azure Policy in contrast constrains what that RBAC can d1. when she/he attempts to create VM 



1.  Some built-in Azure Policy definitions are e.g1.  allowed locations, VM SKU, ensure MMS extension is deployed 

1.  You can create als1. own policies, or initiatives which are collections of policies1.  

1.  Examples 

1. Policy definition e.g1.  allowed locations 

1. Parameters e.g1.  select which regions are allowed 



Deploy with ARM templates 
1.  ARM templates are infrastructure as code foundation of automation and DevOps in Azure 

1.  .1.  Visual Studi1. is a good ARM template editor 

1. Visual Studi1. Code can als1. be used1.  


1.  Different ways to work with templates 


i1.  You can g1. to Portal 1.  Templates 1.  Usage existing usages or add a new template 

ii1.  In Visual Studi1. 1.  Cloud 1.  Azure Resource Group 1.  You can select template location (e.g1.  GitHub) 1.  Select a template 

iii1.  Deploy a VM then in the last step click on "Download template and parameters" 


1.  You can deploy with PowerShell, Cloud Shell, Azure CLI, or directly from Visual Studi1. 

1.  You can automate deployment actions such as VM access 

1.  Files 

1. azuredeploy.json 

1.  Deployment template1.  

1.  Defines resources and property such as allowedValues, defaultValue 

1.  You can refactor some values in variables and reuse in the file 

1.  copy element block in deployment script allows you to create e.g1.  3 storages1.  


1. azuredeploy.parameters.json 

1.  Deployment parameters (required for deployment) to deploy azuredeploy.json 




 
5.3 Compute - Virtual machines (VMs) - VM Scale Sets (VMMS) 
VM Scale Sets (VMSS) 
1.  Group that holds identically configured VMs 

1.  Used for 

1. Need to create and manage multiple VMs 

1.  Centrally create and manage multple VMs (Windows Server or Linux) 


1. Need for high availability and app resiliency 

1.  Horizontal scaling, scaling up and down based on spikes 


1. Need for large (1000) scale 

1.  E.g1.  Azure Batch uses scale sets under the hood 


1. Need for IaaS autoscale 

1.  Scale out and in based on metrics based autoscale 




PaaS Scaling vs IaaS Scaling 
1.  Azure App Service 

1. High agility at the expense of administrative power 

1. The underlying Hyper-V Vms are almost totally abstracted from you 



1. Easy manual, scheduled, or automatic scale out and scale back 


1.  Virtual Machine Scale Set (VMSS) 

1. Maximum administrative power at the expense of agility 

1. VMSS represents Azure's approach to IaaS horizontal scaling 



Deploying a VM Scale Set 
1.  Create virtual machine scale set 

1. Availability zone 

1.  Scale scale sets across one and more availability zones 

1.  All regions d1. not support availability zone 


1. Instance count & instance set 

1. Low priority 

1.  Take advantage of unutilized capacity 

1.  Compute power that customers/Microsoft is not using 

1.  Save costs 


1.  Good for workloads that can handle interruption 

1.  Stateless workloads 

1.  VMs in the scale set may be evicted at any time 

1.  You set eviction policy: 

1.  Stop / Deallocate 

1.  Delete 




1. Use manage/unmanaged disks 

1.  Managed disks are not supported with availability zones 


1. Networking 

1.  Application Gateway 

1.  .1.  Useful if your scale sets are web servers 

1.  D1. not support RDP 


1.  Load Balancer 

1.  Supports RDP 

1.  You set public IP address name and domain name label (domain-name.region.cloudapp.azure.com) 




1.  You can als1. use ARM template e.g1.  Deploy a Windows VM Scale Set with a Custom Script Extension that deploys VMs, load balancer and a powershell script to be executed after deploymento  


Connecting to VMs 
1.  In portal: Choose VM 1.  Settings 1.  Instances you can see all the instances 


1.  to connect to individual instances you need load balancer and NAT (network address translation) 

1. You can't RDP/SSH into individual instances directly 

1. You can connect to load balancer IPs 

1.  In portal: Load Balancer 1.  Inbound NAT rules 


1. NAT maps different VMs on different ports1.  



Configuring Autoscale 
1.  Manual: Through Portal/SDK/CLI/PowerShell 

1.  Autoscale 

1.  Scheduled: If you know when the load will be high you can plan for that and scale with time triggers 

1.  Metrics: Use various metrics from various sources to determine when to scale in/out 

1.  Manage in VMSS 1.  Scaling 1.  

1. Enable auto-scaling 

1. Select scale-mode 

1. Scale based on metric 

1.  Add rule 

1.  E.g1.  increase instance count by 1 when CPU percentage above 70% 

1.  .1.  You should als1. create scale mode that bring down the scale count 

1.  Properties 

1.  Duration: Good to not be confused when scaling out/in, s1. set a duration to e.g1.  10 minutes 

1.  Cooldown: Waits after scale operation before new scale operation 



1. Scale to specific instance count 

1.  Time-based scaling 

1.  Set start and end date 




 
5.41.  Compute - Virtual machines (VMs) - Security 
Security 
Role based access control 
1.  Provides fine-grained access to resources 

1.  AAA 


1. A: Authentication (identity) 

1. A: Authorization (abilities) 

1. A: Accounting (auditing) 


1.  Higher to lower granularity 

1. Management groups 1.  Subscription 1.  Resource group 1.  Resource 


1.  Roles 

1. Reader: Observers 

1. Resource-specific or custom role, contributor: Users managing resources 

1. Owner: Admins 


1.  Custom roles are defined in JSON 

1.  RBAC focuses on user actions at different scopes1.  

1. By contrast, Azure Policy focuses on resource properties during deployment 

1.  Policies e.g1.  Allowed virtual machine SKUs, Enforce automatic OS upgrade with app health checks on VMSS 



1.  You can manage in Access Control (IAM) blade1.  


Storage Security 
Storage Service Encryption 
1.  Protects data at rest in storage account 

1.  128-bit AES encryption 

1.  Azure manages encryption keys 

1. .1.  You can manage them yourself with Azure Key Vault 



Azure Disk Encryption 
1.  BitLocker for Windows Server VMs 

1.  DM-Crypt library for Linux VMs 

1.  Protects OS and data disks 

1.  Azure- or customer- managed disks 

1.  Manage: 

1. In VM blade -> Disks -> Add data disk 

1. Use PowerShell 

a1.  Create key vault and vault key 

b1.  Create security principal (identity in Azure AD) that can take the key from key vault 

c1.  You run SetRmVMDiskEncryption to configure encryption 




Network-level security 
Network Security Group (NSG) 
1.  Stateful firewalls 

1.  Augmented security rules: Have inbound/outbound rules 

1.  Can be bound to public addresses, load balancers, subnets and VMs1.  

1.  Traffic streams are identified with 5-tuple hash: Source, destination, port, protocol, IP addresses1.  

1.  Source can be service tags 

1. In-built e.g1.  Internet 


1.  Or custom (Application Security Group identifiers) 

1. Simplifies NSGs 

1. Logically groups VMs e.g1.  by role 

1.  Association is done through NICs 


1. E.g1.  AppServers, DatabaseServers 

1. Flow: 

a1.  Define ASGs 

b1.  Include ASGs in NSGs 




Host Firewalls 
1.  E.g1.  Windows Defender Firewall on Windows Server VMs 

1.  .1.  A range that's whitelisted in NSG can be blocked by host firewalls1.  


Jumpbox Architecture 
1.  Jumpbox is a pivot point VM in a VNet 

1.  Good for auditing every administrative action 

1. A shared jumpbox makes it easier to administrate the orchestration 


1.  You can e.g1.  allow access to public IP and make sure it's locked down to that endpointo  

1.  Or you can e.g1.  point to Site-to-Site VPN or point-to-site VPNo  


Azure Security Center (ACS) 
1.  Tw1. tiers: Azure Security Center Free Tier, Azure Defender 

1.  See als1. pricing page 


Azure Security Center Free Tier 
1.  Continuous security assessment 

1.  Actionable recommendations 

1.  Prioritized alerts and incidents 

1.  Integrated security solutions 

1. E.g1.  recommends to deploy WAF 



Azure Defender 
1.  Just-in-time VM Access 

1.  Threat protection for Azure VMs and non-Azure servers 

1.  Threat protection for PaaS services 

1.  Regulatory compliance dashboard and reports 


Just-in-Time (JIT) VM Access 
1.  Allowed by Azure Defender for servers (formerly known as Azure Security Center Standard tier) 

1.  Normally to access a VM, you need 3389 for RDP protocol, or 22 to SSH for linux, you open those ports 7/241.  

1. Not s1. secure as they're publicly accessible if IP is public1.  


1.  JIT locks down inbound administrative port access 

1.  Time-restricted access to specific IP address(es) 


 
5.51.  Compute - Virtual machines (VMs) - Backups 
Backups 
VM Disk Snapshots 
1.  .VHD files (data + os disks in page blobs) are stored aas page blobs1.  

1.  Full and incremental point-in-time snapshots 

1.  Faster than performing full back-ups 

1. .1.  The difference is that snapshots are deltas 


1.  Supported in 


1.  Managed disks 

1.  Unmanaged disks 

1. Use AzCopy command line tool to archive to another storage account 


1.  Snapshots cannot outlive their sources blob 

1.  If you delete VMs, snapshots become irrelevant 

1. .1.  Consider archiving them 


1.  You can create new VM from a snapshoto  

1.  In Portal -> VM -> Disks -> Select Disk -> Create Snapshot 

1.  In Snaphots -> Find snapshot -> 

1. Export: 

1. You export with creating SAS URL (time limited) 

1. You get direct URL 



Azure VM Backup 
MARS, Microsoft Agent Recovery Services 
1.  Supports on-prem to cloud 

1.  Supports file/folders but not whole disk back-up 


System Center DPM (Data Protection Manager)* 
1.  Supports system image/whole VM back-ups from on-premises to Azure 


Azure Backup Server (MABS, Microsoft Azure Backup Server) 
1.  Azure specific version of System Center DPM 


Azure Backup 
1.  Azure IaaS VM Backup 

1.  Require recovery services vault 

1. Don't need to worry about storage accounts 


1.  Azure Backup service uses VMSnapshot and VMSnapshotLinux extensions 

1.  VSS orchestrates consistent snapshots of OS and data disks1.  


Consistency levels 
1.  Application-consistent 

1. .1.  Preferred backup type 

1. Data is consistent with time of backup (VSS) 


1.  File-system consistent 

1. Ensures the VM boots and there is neither corruption nor data loss 

1. You may need to take further action to bring data current 


1.  Crash-consistent 

1. Least preferred backup type 

1. Used when you back up a powered down VM 



Manage 
1.  VM -> Backup -> 

1. Create/select recovery services vault 

1. Create back-up policy with backup frequency and retention range 


1.  You can see/start/stop back-ups in Recovery Services vault -> Backup Items 

1. You can create policies in Backup Policies blade1.  


1.  In back-up/replication jobs blade you can list all jobs 


Restore options 
1.  Create a new VM 

1. Basic VM up and running from a restore point 


1.  Restore disk 

1. Restores a VM disk which can then be used to create a new VM1.  

1. Azure Backup provides a template to help you customize and create a VM1.  

1. Useful if you want to customize the VM, add configuration settings that weren't there at the time of backup, or add settings that must be configured using the template or PowerShell1.  


1.  Replace existing 

1. You can restore a disk, and use it to replace a disk on the existing VM1.  

1. Supported for unencrypted managed VMs 

1. 1.  Not supported for unmanaged disks, generalized VMs, or for VMs created using custom images1.  



Recovery Options 
1.  Entire VM 


1. OS and data disks 

1. Configuration 

1. Restore to original or alternate location 

1. Quick create option 

1. Flow: Recovery Services Vault -> Restore VM -> Restore type: Create VM 


1.  Individual Disks 

1. Restore to storage account 

1. Includes ARM deployment template 

1. .1.  Use to control VM restore, gain full control over the VM environment 

1.  Availability set 

1.  vNIC 

1.  IP addresses..1.  


1. Flow 

a1.  Recovery Services Vault -> Restore VM -> Restore type: disks 

b1.  Restore VHD(s) to storage account 

c1.  Create VM configuration 

d1.  Attach the OS and data disks 



1.  Files and Folders 

1. Mount OS and data disks as network drives 

1. Azure VM File Recovery 

1.  E.g1.  "We need to retrieve a few log files from 3 months ago1.  Time is of the essence" 

1.  If it was a VM back-up, it'd be costly as it takes storage etc1.  

1.  With file recovery you can only recover log folders 


1.  Workflow 

1.  Select recovery point 

1.  Download and run PowerShell script 

1.  Recover file system 

1.  Unmount the disks after recovery 


1.  Manage in Recovery Service Vault -> File Recovery 




Azure Site Recovery 
1.  Replication/orchestration engine 

1.  Failover recovery for VMs 

1.  You can use cloud <=> cloud, on-prem <=> cloud, on-prem <=> on-prem 

1.  Provides region level failover 

1.  Physical and virtual (Hyper-V and/or VMware) machines are supported 


1.  Azure as a recovery site 

1.  Migrate to Azure 

1.  Manage in VM -> Disaster Recovery or Recovery Services vault -> Site Recovery (or Recovery Services vault -> Disaster Recovery especially for VMs) 

1. Select target region 

1. Select target resources (e.g1.  VNEt, availability set, RG) to new resources or existing 

1. You can set storage, replication and extension settings 

1. With a recovery plan you can set recovery order, inject code in-between VMs 

1.  You need to d1. it Recovery services vault 



1.  Failover/Failback 

1. In VM -> Disaster Recovery -> 

1.  Select Test failover or Failover 

1.  Click on "Commit" 

1.  Re-protect -> G1. back to the original location 


1. Flow: 

a1.  Prerequisite check 

b1.  Failover 

c1.  Create recovery point 

d1.  Start the VM 

e1.  Clean-up resources 




 
6.1.  Networking - Virtual Network (VNet) 
Virtual Network (VNet) 
1.  Communications and security boundary 

1. Provides network isolation and segmentations 

1. Enables Azure resources to communicate with each other securely 

1.  E.g1.  VMs, storage accounts, App Service apps, Azure SQL database instances 



1.  Uses Azure network backbone 

1. Communications are internal by default unless you explicitly make it external 


1.  Name resolution 

1. Azure-provided DNS 

1. DNS service 


1.  Traffic filtering 

1. NSGs 



1. Network Virtual Appliances 


1.  50-100 VNets allowed per subscription 

1.  A resource can only be created in a virtual network that exists in the same region and subscription as the resource1.  

1.  Why multiple VNets? 

1. Saving money 

1.  Service chaining: Share a network virtual appliance among several VNets 


1. Segmenting workloads 

1.  NSGs and UDRs give you routing and traffic control 

1.  E.g1.  hub and spokes 


1. Securing traffic 

1.  Private connectivity that uses the Microsoft backbone network 



1.  Moving a VNet 

1. 1.  When moving a virtual network, you must als1. move its dependent resources 

1.  For VPN Gateways 

1.  You must move IP addresses, virtual network gateways, and all associated connection resources1.  


1.  .1.  Local network gateways can be in a different resource group1.  


1. to move a peered virtual network, you must first disable the virtual network peering 

1. 1.  You can't move a virtual network to a different subscription if the virtual network contains a subnet with resource navigation links 

1.  For example, if an Azure Cache for Redis resource is deployed into a subnet, that subnet has a resource navigation link1.  




Role of VNet 
1.  You can link app services, storage accounts, VMs 

1.  Provides traffic isolation and segmentation 

1.  Runs on Azure backbone network 

1.  Configure communication with Internet 

1. .1.  Ensure only VMs that need public IP addresses get one1.  


1.  You need to link VNets together to allow communication 

1.  Control traffic flows into the VNET, within the VNET, and between VNets1.  

1.  Have IPv4 address space 

1. Uses CIDR block of private RFC 1918 addresses that are not public/internet routable themselves 


1.  VNets are divided into subnets 

1. E.g1.  in multi-tiered application, web-tier, business-tier, data-tier 



1.  Good for protecting access using NSGs 

1.  Good for having jumpbox and protecting wh1. can connect to jump-box 




VNet Design Best Practices 
1.  Create subnets based on workloads 

1. E.g1.  all of your web front-ends will have similar access requirements, then you can bind NSGs on subnet level1.  


1.  Bind NSGs at the subnet level 

1. Not good to bind at VNet level for better troubleshooting 


1.  Deploy a network virtual appliance (NVA) and user-defined routes (UDRs) to further customize traffic1.  

1. Virtual appliance (NVA) 

1.  E.g1.  enterprise grade firewall appliance, load balancer appliance 

1.  They exist in Azure marketplace 

1.  They'll be installed in VNet as a VM 


1. User defined routes (UDRs) 

1.  Customize and control routing in a VNet 



1.  Implement site-to-site or point-to-site VPN tunnels with on-premises environment 


Deploying a VNet 
1.  You can use ARM templates e.g1.  from Github1.  

1. Visual Studi1. is recommended for editing templates 


1.  During deployment: 

1. Name: Must be unique 

1. Subnet: Default gives you one subnet, for more you can use ARM template or PowerShell/CLI 

1. DDoS protection 

1.  Microsoft publishes their datacenter public IP address 

1.  Bad actors run port-scanners on those IP addresses all the time 


1. Service endpoints 

1.  Allows you to integrate Azure PaaS services 



1.  After deployment: 

1. Address space 

1.  You cannot edit 

1.  You need to create new and delete old one1.  


1. Subnets 



1.  You can always add new subnets & deploy gateway subnet that'll be used by an Azure gateway1.  


1. DNS server 

1.  Default is azure provided 

1.  You can use custom by additional DNS servers 

1.  Affect all VMs 

1.  Still uses Azure DNS when necessary 

1.  Used when e.g1.  site-to-site or point-to-site connections, it'll affect all VMs1.  



1. Diagram 

1.  You can enable network watcher here1.  

1.  You then load in subscription or RG and enable1.  

1.  It shows topology 




Network Security Groups (NSG) 
1.  Stateful firewall for inbound and outbound traffic 

1. Stateful = 5-tuple hash 

1.  Source + destination IP and ports 

1.  Protocol 



1.  Has default rules 

1.  Augmented rules 

1. Allow you specify list of IP-addresses 

1. No need to create several rules for same list 


1.  Service tags 

1. Azure defined named IP address endpoints 

1. E.g1.  Internet, VirtualNetwork, AzureLoadBalancer, AzureTrafficManager, Storage, SQL, AzureCosmosDB, AzureKeyVaulto  

1. Allows you to use names instead of IP addresses 


1.  Application Security Groups (ASGs) 

1. Custom (user-defined) logical identifiers 

1. You can associate IP ranges and then use it as source/destination in NSGs1.  

1. E.g1.  WebServer, WappServers, DbServers 


1.  Can be bound to VNets, subnets or NICs 

1. .1.  Bind to subnets 


1.  Security rules 

1. Priority: Lower the number, higher the priority of the rules 



IP Addressing Best Practices 
1.  If a VM doesn't need a public IP address (PIP), then don't assign one and use an Azure load balancer instead1.  

1.  Plan your VNet private address space to avoid overlap1.  

1. Different from on-premises 

1. Different from other VNets in Azure 


1.  Never configure networking from within the VM 

1. D1. it on Azure instead using Azure abstractions 



Network Interfaces 
1.  Assigned to a single subneto  

1.  Have a public or private IP that's dynamic or static1.  

1.  IP forwarding 

1. E.g1.  if you have network appliance and you want to give it ability to forwar traffic that's not destined for itself 



 
6.1.1.  Networking - Virtual Network (VNet) - Connecting VNets 
Connecting VNets 
1.  You don't need to have a Layer 3 router to route traffic from subnet to subnet 

1.  Azure system routes take care of the routing for you automatically 


Options 
VPN Gateway 
1.  Creates IPsec/IKEv2 tunnel and always-on connection 

1.  Used for connecting VPNs in cloud or hybrid scenario1.  


Inside Azure 
VNet-to-VNet VPN 
1.  Create isolation or administrative boundaries 

1.  Provide cross-region geo-redundancy and replication securely 

1.  No traffic crosses the public internet 

1.  Separate VPN gateways costs while VNet peering is free1.  

1.  .1.  Make sure your VNet address spaces d1. not overlap1.  

1.  Troubleshooting 

1. Verify connectivity through peering 

1.  Set up Azure DNS 




VNet peering 
1.  Seamless connection between tw1. Azure VNets1.  

1. The peered networks appear as one, for connectivity purposes1.  

1. Name resolution does not flow, requires own DNS zone 


1.  Runs on Azure backbone 

1.  .1.  You can peer across regions and subcriptions 

1.  Peering can overcome misplaced VMs 

1.  Save money with service chaining (e.g1.  services' communication are chained through a subnet) 

1.  Peering must be done on both sites 

1. VNet1 <=> VNet2 and VNet2 <=> VNet1 


1.  Configuration 

1. Allow forwarded traffic 

1.  Am I peering from a hub VNet that'll have IP-forwarder? 

1.  Allow peers (other VNets) to forward traffic to g1. through1.  


1. Allow gateway transit 

1.  Am I hosting a VPN gateway? 


1. Use remote gateways 

1.  Is this network use peer s gateway? 

1.  VNets must be in same region 



1.  Enables force tunnelling 

1. E.g1.  when all Internet traffic must g1. through on-premises firewall device1.  

1. You can use user defined routes for all outbound traffic to g1. back through VPN gateway to on-premises1.  


1.  Peerings are not transitive 


1. If you peer spoke1 <=> spoke2 and spoke2 <=> spoke3 then spoke1 cannot communicate with spoke3 automatically1.  

1. Common solution is transiting VNet with Hub and Spoke topology1.  

1.  Topology is a segmentation 

1.  When to segment with VNets and when with subnets? 

1.  Depends on bureaucratic reasons 

1.  E.g1.  different VNets when 

1.  Different cost centers/groups need management autonomy 

1.  You want to completely isolate different workloads 




1.  Name resolution needs configurations 

1.  You can't d1. with Azure provided DNS as all your hosts have then internal.cloudapp.net 

1.  In peering azure provided DNS won't work 




1.  Troubleshooting tips 

1. Azure blocks ICMP between Vnets and the Internet 

1.  ICMP is used for ping 

1.  Microsoft blocks it because of DDoS attacks1.  


1. Simplify NSGs as much as possible to reduce troubleshooting friction 

1. Azure portal Diagnose and solve problems/Resource health blade is useful 

1. Network Watcher and Network Permormance Monitor make troubleshooting much easier 

1.  Network Watcher 

1.  Shows where's the traffic is captured/denied 

1.  Suite of tools 

1.  Topology: e.g1.  VNETs, subnets, VMs, NICs 

1.  Variable Packet Capture: Captures TCP packages at NIC level as wireshark files1.  

1.  IP Flow Verify: Troubleshoots NSG 

1.  Next hop: Troubleshoots route tables 

1.  Connection troubleshoot: Why it does not connect? 

1.  Diagnostics Logging 

1.  Security Group View 

1.  NSG Flow Logging 

1.  VPN Gateway Troubleshooting 

1.  Network Subscription Limits 

1.  Role Based Access Control 


1.  In Portal you can search for Network Watcher and enable it on VMs 





1.  Network Performance Monitor 

1.  E.g1.  top network health events, ExpressRoute monitor, service endpoint monitor, performance monitor 

1.  It ties in logs/metrics with Log Analytics1.  

1.  Part of Insights & Analytics Azure management solutioNo  

1.  Works with installing Microsoft Monitoring Agent (MMA) in VM1.  

1.  Flow 

a1.  Deploy Insight & Analytics and then select Network Performance Monitor 

b1.  Choose VM and click on "Connect", it'll install MicrosoftMonitoringAgent 






Hybrid Connections 
Site-to-site VPN 
1.  Tw1. VPN devices connect to each other1.  

1.  Flow 

i1.  Deploy a VPN Gateway resource in Azure 

1.  Requires gateway subnet (or DMZ subnet)1.  

1.  Different SKUs: Basic, VpnGw1, VpnGw2, VpnGw3 

1.  You get more bandwidth, site-to-site and point-to-site points1.  

1.  Don't use basic for production 


1.  You can see the deployed VPN Gateway in Connected Devices in subneto  


ii1.  Deploy a Local Network Gateway as well1.  

1.  For your on-prem gateway device, you need to set up one of the route table configurations: 

1.  PolicyBased 

1.  Handle route tables manually 

1.  Does not work with BGP failover, active-to-active configurations 

1.  RouteBased 

1.  .1.  Always use if possible 

1.  Some VPN devices d1. not support it 

1.  What's compatible is documented on Microsoft docs1.  





iii1.  Create a connection between tw1. gateways 

1.  Create local-to-azure in Local Network Gateway 

1.  Create azure-to-local in VPN Gateway 

1.  In Shared Key in connection blade, specify a key1.  




Point-to-site VPN 
1.  Allows access to Azure resources through VPN tunnel from a client agento  

1.  More portable way 

1.  Flow 

i1.  On Azure deploy VPN gateway 

ii1.  In Point-to-site configuration blade download VPN client 

iii1.  Deploy agent (a VPN Client) from VPN gateway 

iv1.  Install on individual endpoints (e.g1.  laptops) 


1.  Allows connection outside network perimeter 


Express route 
1.  High speed secure connection between on-prem and cloud 


Best practices for High Availability 
1.  Combine ExpressRoute and VPN 

1. In gateway subnet 

1.  Deploy ExpressRoute gateway 

1.  Deploy VPN Gateway 


1. Both gateways gives access to front-end tier and a jumpbox in a management subnet 

1. If ExpressRoute goes down VPN gateway gets activated 


1.  Deploy tw1. VPNs 

1. Requires enabling BGP in gateway link 

1.  Robust routing 

1.  Enable active-to-active connection configuration 

1.  Only allowed RouteBased routing configuration 


1. Tw1. VPN gateways on-prem 

1.  Allows redundant active-to-active connection to single gateway1.  

1.  You have one active and one stand-by gateway 




System Routes vs1.  User-defined Routes 
1.  Situations 

1. You need to move one VM to another VNeto  

1.  It requires re-deploying 


1. Isolation & segmentations 



1.  E.g1.  development / production VNet 


1. Hub & Spoke Topology 

1.  Hub: VNet have Virtual Network Appliance (e.g1.  firewall), or gateway 

1.  You don't want to have Virtual Network Appliance as it costs both money and resources1.  


1.  Spokes 

1.  Other VNets (e.g1.  front-end, back-end) 

1.  You can force communicates with each other through Hub1.  




1.  Internet calls and calls from internet 

1. Handled by Azure using system routes 

1. You don't need to manipulate them 


1.  If you want to override system routes (e.g1.  for Hub & Spoke topology) 

1. You need User Defined Routing 

1. For network appliance you need to configure IP forwarding 

1.  Enables it to pass on traffic that it's not destined for itself1.  




 
6.1.21.  Networking - Virtual Network (VNet) - DNS & Name Resolution 
DNS & Name Resolution 
Azure-provided name resolution 
1.  No configuration required 

1.  All VMs within a VNet can resolve each others' host names 

1.  Limitations 

1. Cross-VNet name resolution 

1. Issue: No custom DNS suffix 


1.  You can add custom DNS server IP addresses 

1. E.g1.  in hybrid cloud if you want Azure VMs to have IP addresses from on-premises DNS server or vice versa1.  

1. E.g1.  stand up own DNS servers in VNet instead1.  

1. E.g1.  configure DNS forwarding between one DNS server in one VNet to another DNS server in another VNet 



Azure DNS 
1.  Allows VNETs to resolve each others host names1.  


1.  Host your public DNS domain in Azure 

1. Use Azure geo-distributed name servers for high speed name resolution 

1. Delegate a domain: 

a1.  Create a DNS Zone 

b1.  Copy an Azure DNS name server from the zone 

c1.  In the registrar's DNS management page, edit the NS records and replace the NS records with the Azure DNS name servers1.  



1.  You manage in Portal -> DNS zone 

1. Each DNS zone has 

1.  VNets of associated with it 

1.  Record-sets: IP addresses and host names of VMs 



1.  Create private DNS zones 

1. Allows you to not route names in public DNS 

1. Linked to VNets 

1.  Lets you avoid setting up own DNS infrastructure 


1. Registration VNet 

1.  You create private DNS zone and registration VNet 

1.  Any VMs within that VNet will automatically have their names registered and DNS records created in Azure DNS 


1. Resolution VNet 

1.  Allows you to have name resolution across VNets 

1.  Other VNets will be resolution VNets 

1.  Allows you to create records (hosts, alias) for VMs and it'll support name resolution across VNets 




Hybrid Cloud 
1.  .Azure provided DNS won't work with peering1.  

1.  A potential solution: 

1. On-prem: Configure own DNS server and configure forward queries to Azure1.  

1. In Azure 

1.  Connect VNets (peer or VPN) 

1.  Deploy own DNS servers in VNets and configure forwarding there 


1. 1.  To1. much overhead 


1.  .1.  Use Azure DNS Private Zones instead 

1. Configure Azure DNS servers specifically for private zones1.  

1. One network: Registration network 

1.  Hosts will have their names auto-registered in private zones1.  


1. Other networks: Resolution networks 



1.  You need to manually create hosts in CNAME/MX records1.  


1. Set-up DNS name for peered Virtual Appliance and a VNet in a Hub & Spoke topology 

1.  Existing VMs 

1.  [Host (spoke) VM] in [Host (spoke) VNet] 

1.  [Hub (virtual appliance, hybrid)] VM in [Hub (virtual appliance, hybrid) VNet] 


b1.  Create & set-up route table 

a1.  Create a route table -> Routes -> Add -> 

1.  Name: E.g1.  subnet1-nva 

1.  Address prefix: If destination IP of a packet matches this then it matches the rules1.  E.g1.  192.168.8.0/24 

1.  Next hop type: Virtual network gateway, virtual network, internet, virtual appliance, none1.  

1.  Choose [Hub (virtual appliance, hybrid) VM] 


1.  Set next-hop address to IP of [Hub (virtual appliance, hybrid) VM] 


b1.  Associate route table to related subnets 

1.  Route-table -> Subnets -> Associate subnet 



c1.  Set-up peering 

1.  You can ping to VNets as name resolution does not work across VNets 

1.  Set-up without any allow forwarded traffic, allow gateway transit, use remote gateways configuration 

1.  [Hub (virtual appliance, hybrid) VNet] <=> [Host (spoke) VNet] 



d1.  Create DNS Zone 

1.  In portal -> DNS zone -> Add DNS zone 

1.  Create private DNS zone in VA (hybrid) VNet 

1.  Create DNS zone 

1.  Register record set with IP and name of each VM 

1.  Register tw1. VNets 

1.  Registration VNET for [Hub (virtual appliance, hybrid) VM] 

1.  Resolution VNET for [Host (spoke) VM] 







 
6.21.  Networking - Load Balancers 
Load Balancer Options 
1.  All load balancers are software appliances (software defined networking: SDN) 

1.  .1.  Only Standard (not Basic) SKU allows availability zones in Load balancer 


Public Load Balancer 
1.  OSI Layer 4 TCP and UDP 

1.  Internet-facing, has public IP address 

1.  Offers tw1. distribution modes 

1.  Set-up public load balancer 

i1.  Settings -> Back-end-pools-> Add VMs 

ii1.  Settings -> Health-probe -> Add health probe 

1.  E.g1.  tcp-80-probe (HTTP) probe 

1.  Set interval -> time between prop events 

1.  Set unhealth threshold (e.g1.  2) before VM is dropped out from the pool 

1.  Add load balancing port 

1.  Incoming request from port 80 (port) will be passed to TCP passed 80 (back-end port) 

1.  Select backend pool & health-probe 

1.  Set session persistence 

1.  Floating IP (direct server return) 

1.  Use with internal load balancers 

1.  Use with SQL server always on cluster 

1.  Used when same back-end port needs to be used across multiple rules in a single Load Balancer1.  



iii1.  Add inbound NAT rule 

1.  Map TCP 5000 to a VMs RDP port (3389) 

1.  Map TCP 5000 to a VMs RDP port (3389) 




Internal load balancer 
1.  OSI Layer 4 TCP and UDP 

1.  Applies to traffic only within a virtual network 

1. No public IP address 


1.  Good for applying load balancing to n-tier application services (database) 


Application Gateway 
1.  OSI Layer 7 application 

1.  Application Delivery Controller (ADC) as a service 

1.  SSL offload 

1.  Has Web Application Firewall (WAF) 


Traffic Manager 
1.  DNS-level 

1.  Geographical load balancing 

1.  Offers different routing methods 


 

